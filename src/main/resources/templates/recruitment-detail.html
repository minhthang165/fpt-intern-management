<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi ti·∫øt Tuy·ªÉn D·ª•ng</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      max-width: 800px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
    }
    .header img {
      max-width: 100px;
      height: auto;
      position: absolute;
      right: 0;
      top: 0;
    }
    h2 {
      color: #2c3e50;
      font-size: 28px;
      margin: 0;
    }
    p {
      color: #333;
      font-size: 18px;
      margin: 15px 0;
    }
    .description {
      background: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      font-size: 16px;
    }
    .btn-container {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      display: inline-block;
      padding: 15px 25px;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      transition: 0.3s;
      font-size: 18px;
    }
    .back-link {
      background-color: #95a5a6;
      color: white;
    }
    .back-link:hover {
      background-color: #7f8c8d;
    }
    .apply-btn {
      background-color: #3498db;
      color: white;
      font-size: 20px;
    }
    .apply-btn:hover {
      background-color: #2980b9;
    }
    #message {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
    .cv-select-container {
      margin: 15px 0;
    }
    #cvSelect {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<input type="hidden" id="user_id" th:value="${user_id}">
<div class="container">
  <div class="header">
    <h2 th:text="${recruitment.position}"></h2>
    <img src="/assets/img/sign/FPT_logo_2010.svg" alt="Company Logo">
  </div>
  <p><strong>Kinh nghi·ªám y√™u c·∫ßu:</strong> <span th:text="${recruitment.experience_requirement}"></span></p>
  <p><strong>Ng√¥n ng·ªØ y√™u c·∫ßu:</strong> <span th:text="${recruitment.language}"></span></p>
  <p><strong>S·ªë l∆∞·ª£ng tuy·ªÉn:</strong> <span th:text="${recruitment.totalSlot}"></span></p>
  <p class="description"><strong>M√¥ t·∫£:</strong> <span th:text="${recruitment.description}"></span></p>

  <!-- √î ch·ªçn CV -->
  <div class="cv-select-container">
    <label for="cvSelect"><strong>Ch·ªçn CV:</strong></label>
    <select id="cvSelect">
      <option value="">-- Ch·ªçn CV ƒë·ªÉ apply --</option>
    </select>
  </div>

  <div class="btn-container">
    <a href="/recruitment/recruitments" class="btn back-link">üîô Quay l·∫°i danh s√°ch</a>
    <button id="applyButton" class="btn apply-btn">üì§ Apply job</button>
  </div>

  <p id="message"></p>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("applyButton").addEventListener("click", applyJob);
    loadCVList();
  });

  function getIdsFromPath() {
    let pathSegments = window.location.pathname.split('/');
    let recruitmentId = pathSegments[pathSegments.length - 1];
    console.log("Extracted recruitmentId:", recruitmentId);
    return { recruitmentId };
  }

  async function loadCVList() {
    const userId = document.getElementById("user_id").value;
    const cvSelect = document.getElementById("cvSelect");

    try {
      console.log("Fetching CV list for userId:", userId);
      let response = await fetch(`/file/user/${userId}/all`);
      console.log("CV list API response status:", response.status);

      if (!response.ok) {
        throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch CV!");
      }

      let cvList = await response.json();
      console.log("Received CV list:", cvList);

      cvSelect.innerHTML = '<option value="">-- Ch·ªçn CV ƒë·ªÉ apply --</option>';

      cvList.forEach(cv => {
        let option = document.createElement("option");
        option.value = cv.id;
        console.log("CV object:", cv); // Debug d·ªØ li·ªáu
        option.text = cv.displayName || cv.fileName || `CV ${cv.id}`; // ∆Øu ti√™n displayName
        option.dataset.driveLink = cv.path || cv.driveLink || ""; // Linh ho·∫°t v·ªõi path/driveLink
        cvSelect.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading CV list:", error);
      cvSelect.innerHTML = '<option value="">Kh√¥ng c√≥ CV n√†o</option>';
    }
  }

  async function applyJob() {
    let messageEl = document.getElementById("message");
    let { recruitmentId } = getIdsFromPath();
    const userId = document.getElementById("user_id").value;
    const cvSelect = document.getElementById("cvSelect");
    const selectedCV = cvSelect.options[cvSelect.selectedIndex];

    console.log("User ID:", userId);
    console.log("Recruitment ID:", recruitmentId);
    console.log("Selected CV ID:", selectedCV.value);

    if (!recruitmentId || !userId || isNaN(recruitmentId) || isNaN(userId)) {
      messageEl.textContent = "‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin tuy·ªÉn d·ª•ng ho·∫∑c ng∆∞·ªùi d√πng.";
      messageEl.style.color = "red";
      return;
    }

    if (!selectedCV.value) {
      messageEl.textContent = "‚ùå Vui l√≤ng ch·ªçn m·ªôt CV ƒë·ªÉ apply!";
      messageEl.style.color = "red";
      return;
    }

    try {
      const fileId = selectedCV.value;
      let driveLink = selectedCV.dataset.driveLink;

      // N·∫øu driveLink kh√¥ng c√≥ trong dataset, fetch t·ª´ /file/file/path/{fileId}
      if (!driveLink) {
        console.log("No driveLink in dataset, fetching from API for fileId:", fileId);
        let pathResponse = await fetch(`/file/file/path/${fileId}`);
        console.log("File path API response status:", pathResponse.status);

        if (!pathResponse.ok) {
          throw new Error("Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng d·∫´n CV!");
        }
        driveLink = await pathResponse.text();
      }

      console.log("Selected fileId:", fileId);
      console.log("Selected driveLink:", driveLink);

      if (!driveLink || driveLink === "undefined") {
        throw new Error("ƒê∆∞·ªùng d·∫´n CV kh√¥ng h·ª£p l·ªá!");
      }

      const formData = new FormData();
      formData.append("driveLink", driveLink);
      formData.append("fileId", fileId);
      formData.append("recruitmentId", recruitmentId);

      console.log("Sending data:", { driveLink, fileId, recruitmentId });

      let applyResponse = await fetch("/cv/save", {
        method: "POST",
        body: formData
      });

      console.log("Apply API response status:", applyResponse.status);

      if (!applyResponse.ok) {
        const errorText = await applyResponse.text();
        throw new Error(`Apply th·∫•t b·∫°i: ${errorText}`);
      }

      let applyData = await applyResponse.text();
      console.log("Apply response data:", applyData);

      messageEl.textContent = "‚úÖ Apply th√†nh c√¥ng!";
      messageEl.style.color = "green";
    } catch (error) {
      console.error("Error:", error);
      messageEl.textContent = "‚ùå " + error.message;
      messageEl.style.color = "red";
    }
  }
</script>

</body>
</html>