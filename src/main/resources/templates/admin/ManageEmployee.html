<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include/master-header :: head"></head>
<style>

    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #f4f4f4;
    }

    .search__bar input {
        margin-right: auto;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 500px;
    }
    .breadcrum__button{
        display: flex;
        padding-left: 120px;
    }
    .search__bar input {
        border: 1px solid #ccc;
        border-radius: 15px;
        width: 400px;
        height: fit-content;
    }

    .modal-backdrop {
        display: none;
    }

    .lock-icon {
        font-size: 20px;
        margin-left: 10px;
        cursor: pointer; /* Biến icon thành nút có thể nhấn */
    }

    .active {
        color: green; /* Màu xanh khi lớp đang hoạt động */
    }

    .inactive {
        color: red; /* Màu đỏ khi lớp bị khóa */
    }
</style>
<body class="body-area">
    <th:block  th:replace="~{include/admin-sidebar :: sidebar(~{::content})}">
        <!--header breadcrumb area-->
        <div class="app__slide-wrapper" th:fragment="content">
            <div class="breadcrumb__area">
                <div class="breadcrumb__wrapper mb-35" style="padding: 0px;">
                    <div class="breadcrumb__main">
                        <div class="breadcrumb__inner">
                            <div class="breadcrumb__icon">
                                <i class="flaticon-home"></i>
                            </div>
                            <div class="breadcrumb__menu">
                                <nav>
                                    <ul>
                                        <li><span><a href="authenticate">Dashboard</a></span></li>
                                        <li class="active"><span>Manage Student</span></li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                        <div class="search_add d-flex justify-content-between align-items-center">
                            <form method="get" action="">
                                <div class="search_add d-flex justify-content-between align-items-center">
                                    <div class="search__bar d-flex">
                                        <input type="text" id="searchValue" name="searchValue" placeholder="Search by..." aria-label="Search students"/>
                                    </div>
                                    <div class="col-md-1 input d-flex "  style="padding-bottom: 18px; margin-left: 5px;" >
                                        <button type="submit"  class="btn element__btn border-yellow find-button manage-student-find-button mt-15" style="margin-top: 15px" >Import</button>
                                    </div>
                                </div>
                            </form>
                            <div class="new_class">
                                <div class="breadcrum__button">
                                    <button class="element__btn  yellow-bg" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                        Add Employee +
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- insert custom content here -->
        <section th:fragment="content">
            <div class="flex-grow-1 p-4">
                <h3 style="font-weight: bold">Employee List</h3>
                <!-- Table -->
                <div class="card mt-4">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Phone number</th>
                                    <th>Gender</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            <tr th:each="user : ${userList}" th:if="${user.role.name()== 'EMPLOYEE'}">
                                <td th:text="${user.first_name + ' ' + user.last_name}"></td>
                                <td th:text="${user.email}"></td>
                                <td th:text="${user.phone_number}"></td>
                                <td th:text="${user.gender}"></td>
                                <td th:text="${user.role}"></td>
                                <!--Nút Delete-->
                                <td th:classappend="${user.isActive()} ? 'active' : 'inactive'">
                                    <a href="#" th:data-id="${user.id}" class="toggle-class-status open-modal">
                                        <i th:data-id="${user.id}"
                                           th:class="${user.isActive()} ? 'flaticon-padlock active' : 'flaticon-padlock inactive'"
                                           onclick="toggleActiveStatus(this, event)">
                                        </i>
                                    </a>
                                    <a href="#" class="edit-user-modal" th:data-id="${user.id}" onclick="openEditUserModal(this, event)">
                                        <i class="flaticon-edit edit-user-modal" style="cursor: pointer"></i>
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Open Confirm modal -->
            <div class="modal fade" id="genericModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalTitle">Title</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="modalMessage">Message here...</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary d-none" id="modalCancelBtn" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary d-none" id="modalConfirmBtn">Yes</button>
                            <button type="button" class="btn btn-success d-none" id="modalOkBtn" data-bs-dismiss="modal">OK</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="editUserModal" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Employee</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <input type="hidden" id="editUserId">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="editFullName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="editEmail" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Phone number</label>
                                    <input type="email" id="editPhoneNumber" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Gender</label>
                                    <select id="editGender" class="form-control">
                                        <option value="MALE">MALE</option>
                                        <option value="FEMALE">FEMALE</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <select id="editRole" class="form-control">
                                        <option value="ADMIN">ADMIN</option>
                                        <option value="EMPLOYEE">EMPLOYEE</option>
                                        <option value="INTERN">INTERN</option>
                                        <option value="GUEST">GUEST</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="updateUser()">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Add User -->
            <div id="addUserModal" class="modal fade" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addUserModalLabel">Add Employee</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addUserForm">
                                <div class="mb-3">
                                    <label for="addUserName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="addUserName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="addUserEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="addUserEmail" required>
                                </div> <div class="mb-3">
                                    <label for="addUserEmail" class="form-label">PhoneNumber</label>
                                    <input type="email" class="form-control" id="addUserPhoneNumber" required>
                                </div>
                                <div class="mb-3">
                                    <label for="addUserGender" class="form-label">Gender</label>
                                    <select class="form-control" id="addUserGender">
                                        <option value="MALE">Male</option>
                                        <option value="FEMALE">Female</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="addUserRole" class="form-label">Role</label>
                                    <select class="form-control" id="addUserRole">
                                        <option value="ADMIN">Admin</option>
                                        <option value="EMPLOYEE">Employee</option>
                                        <option value="INTERN">Intern</option>
                                        <option value="GUEST">Guest</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
                        </div>
                    </div>
                </div>
            </div>


        </section>
    </th:block>

<footer th:replace="~{include/master-footer :: footer}"></footer>
<script>
    document.addEventListener("click", function (event) {
        let icon = event.target.closest(".flaticon-padlock");
        if (!icon) return;

        event.preventDefault();
        event.stopPropagation();

        let userId = icon.getAttribute("data-id");
        if (!userId) {
            showModal("Error", "Missing user ID!");
            return;
        }

        let isUnlock = icon.classList.contains("inactive");
        let action = isUnlock ? "unlock" : "lock";
        let message = isUnlock ? "Are you sure you want to unlock this user?" : "Are you sure you want to lock this user?";

        showModal("Confirm", message, true, function () {
            toggleUserStatus(userId, action);
        });
    });

    function toggleUserStatus(userId, action) {
        let url = action === "unlock" ? `api/user/setIsActiveTrue/${userId}` : `api/user/delete/${userId}`;
        let method = action === "unlock" ? "PATCH" : "DELETE";

        fetch(url, { method: method })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(() => {
                let successMessage = action === "unlock" ? "User has been unlocked!" : "User has been locked!";
                showModal("Success", successMessage);

                let icon = document.querySelector(`.flaticon-padlock[data-id="${userId}"]`);
                if (icon) {
                    icon.classList.toggle("inactive");
                    icon.classList.toggle("active");
                }
            })
            .catch(error => showModal("Error", "Error: " + error.message));
    }

    function showModal(title, message, isConfirm = false, confirmCallback = null) {
        let modalTitle = document.getElementById("modalTitle");
        let modalMessage = document.getElementById("modalMessage");
        let confirmBtn = document.getElementById("modalConfirmBtn");
        let cancelBtn = document.getElementById("modalCancelBtn");
        let okBtn = document.getElementById("modalOkBtn");

        modalTitle.innerText = title;
        modalMessage.innerText = message;

        if (isConfirm) {
            confirmBtn.classList.remove("d-none");
            cancelBtn.classList.remove("d-none");
            okBtn.classList.add("d-none");

            confirmBtn.onclick = function () {
                confirmCallback();
                let modalInstance = bootstrap.Modal.getInstance(document.getElementById("genericModal"));
                modalInstance.hide();
            };
        } else {
            confirmBtn.classList.add("d-none");
            cancelBtn.classList.add("d-none");
            okBtn.classList.remove("d-none");
        }

        let modal = new bootstrap.Modal(document.getElementById("genericModal"));
        modal.show();
    }

    function openEditUserModal(element, event) {
        event.preventDefault();
        let userId = element.getAttribute("data-id");

        // Gửi request để lấy thông tin user
        fetch(`/api/user/${userId}`)
            .then(response => response.json())
            .then(user => {
                document.getElementById("editUserId").value = user.id;
                document.getElementById("editFullName").value = user.first_name + " " + user.last_name;
                document.getElementById("editEmail").value = user.email;
                document.getElementById("editGender").value = user.gender;
                document.getElementById("editRole").value = user.role;

                // Hiển thị modal
                $('#editUserModal').modal('show');
            })
            .catch(error => console.error("Error fetching user:", error));
    }

    function updateUser() {
        let fullNameInput = document.getElementById("editFullName");
        let emailInput = document.getElementById("editEmail");
        let phoneNumberInput = document.getElementById("editPhoneNumber");
        let genderInput = document.getElementById("editGender");
        let roleInput = document.getElementById("editRole");
        let userId = document.getElementById("editUserId").value;

        let fullName = fullNameInput.value.trim();
        let email = emailInput.value.trim();
        let phoneNumber = phoneNumberInput.value.trim();

        let isValid = true;

        clearErrors();
        document.querySelectorAll(".error-message").forEach(e => e.remove());
        [fullNameInput, emailInput, phoneNumberInput].forEach(input => input.classList.remove("is-invalid"));


        if (fullName === "") {
            showError(fullNameInput, "This field is required");
            isValid = false;
        }
        if (email === "") {
            showError(emailInput, "This field is required");
            isValid = false;
        }
        if (phoneNumber === "") {
            showError(phoneNumberInput, "This field is required");
            isValid = false;
        }

        if (!isValid) return;

        let updatedUser = {
            first_name: fullName.split(" ")[0],
            last_name: fullName.split(" ").slice(1).join(" "),
            email: email,
            phone_number: phoneNumber,
            gender: genderInput.value,
            role: roleInput.value
        };

        fetch(`/api/user/update/${userId}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updatedUser)
        })
            .then(response => response.json())
            .then(user => {
                $('#editUserModal').modal('hide');
                location.reload();
            })
            .catch(error => console.error("Error updating user:", error));
    }



    function addUser() {
        let fullNameInput = document.getElementById("addUserName");
        let emailInput = document.getElementById("addUserEmail");
        let phoneNumberInput = document.getElementById("addUserPhoneNumber");
        let genderInput = document.getElementById("addUserGender");
        let roleInput = document.getElementById("addUserRole");

        let fullName = fullNameInput.value.trim();
        let email = emailInput.value.trim();
        let phoneNumber = phoneNumberInput.value.trim();

        let isValid = true;

        document.querySelectorAll(".error-message").forEach(e => e.remove());
        [fullNameInput, emailInput, phoneNumberInput].forEach(input => input.classList.remove("is-invalid"));

        if (fullName === "") {
            showError(fullNameInput, "This field is required");
            isValid = false;
        }
        if (email === "") {
            showError(emailInput, "This field is required");
            isValid = false;
        }
        if (phoneNumber === "") {
            showError(phoneNumberInput, "This field is required");
            isValid = false;
        }

        if (!isValid) return;

        let newUser = {
            first_name: fullName.split(" ")[0],
            last_name: fullName.split(" ").slice(1).join(" "),
            email: email,
            phone_number: phoneNumber,
            gender: genderInput.value,
            role: roleInput.value
        };

        fetch('api/user/create-employee', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(newUser)
        })
            .then(response => response.json())
            .then(user => {
                $('#addUserModal').modal('hide');
                location.reload();
            })
            .catch(error => console.error("Error adding user:", error));
    }

    function showError(input, message) {
        let error = document.createElement("div");
        error.className = "error-message text-danger mt-1";
        error.innerText = message;
        input.parentNode.appendChild(error);
        input.classList.add("is-invalid");
    }

    function clearErrors() {
        let inputs = document.querySelectorAll(".is-invalid");
        inputs.forEach(input => input.classList.remove("is-invalid"));

        let errorMessages = document.querySelectorAll(".invalid-feedback");
        errorMessages.forEach(error => error.remove());
    }

</script>
</body>
</html>






