<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include/master-header :: head"></head>

<style>
    /*css pagination*/
    /* Records selector styling */
    .records-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
    }

    .records-per-page {
        height: 2.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        background-color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .table-footer {
        justify-content: space-between;
        display: flex;
        margin-top: 16px;
    }

    .records-per-page:focus {
        border-color: #3b82f6;
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
    }

    /* Pagination container */
    .pagination-container {
        display: flex;
        justify-content: flex-end;
    }

    .pagination-list {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    /* Pagination items */
    .pagination-item {
        display: inline-block;
    }

    .pagination-link {
        display: inline-flex;
        height: 2.25rem;
        min-width: 2.25rem;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        background-color: #fff;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        padding: 0 0.5rem;
    }

    .pagination-link:hover {
        background-color: #f3f4f6;
        border-color: #d1d5db;
    }

    /* Active page */
    .pagination-item.active .pagination-link {
        background-color: #f38321;
        color: white;
        border-color: #f38321;
    }

    .pagination-item.active .pagination-link:hover {
        background-color: #f38321;
    }

    /* Disabled pagination items */
    .pagination-item.disabled .pagination-link {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Arrow icons */
    .pagination-arrow {
        font-weight: bold;
    }

    .arrow-icon {
        font-size: 1.25rem;
        line-height: 1;
    }

    /* Ellipsis */
    .ellipsis {
        display: inline-block;
        padding: 0 0.25rem;
    }

    /*css table*/
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #f4f4f4;
    }
    .classroom-title {
        font-size: 32px;
        font-weight: bold;
    }
    .search__bar input {
        margin-right: auto;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 500px;
    }
    .breadcrum__button{
        display: flex;
        padding-left: 120px;
    }
    .search__bar input {
        border: 1px solid #ccc;
        border-radius: 15px;
        width: 400px;
        height: fit-content;
    }
    .pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .pagination button {
        padding: 6px 8px;
        margin: 0 3px;
        border: none;
        cursor: pointer;
        background-color: #ccc;
        border-radius: 3px;
        font-size: 12px;
    }
    .pagination .active {
        background-color: orange;
        color: white;
    }

    .lock-icon {
        font-size: 20px;
        margin-left: 10px;
        cursor: pointer; /* Biến icon thành nút có thể nhấn */
    }

    .active {
        color: green; /* Màu xanh khi lớp đang hoạt động */
    }

    .inactive {
        color: red; /* Màu đỏ khi lớp bị khóa */
    }

    .modal-content {
        position: relative;
        z-index: 1070;
    }

    .modal-backdrop {
        display: none;
    }


    select {
        width: 100%;
        padding: 10px;
        border: 2px solid #98b2da;
        border-radius: 8px;
        font-size: 16px;
        background-color: white;
        color: #333;
        cursor: pointer;
        transition: 0.3s;
    }

    select:hover {
        border-color: #85b7ec;
    }

    select:focus {
        outline: none;
        border-color: #ff9800;
        box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
    }

    .custom-dropdown {
        position: relative;
        display: inline-block;
        width: 200px;
    }

    .custom-dropdown select {
        width: 100%;
        padding: 10px;
        border: 2px solid #28a745;
        border-radius: 8px;
        font-size: 16px;
        appearance: none;
        background-color: white;
        color: #333;
        cursor: pointer;
    }

    .custom-dropdown::after {
        content: "▼";
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        color: #28a745;
        font-size: 14px;
    }

    .custom-dropdown select:focus {
        outline: none;
        border-color: #218838;
    }
</style>

<body class="body-area">
<th:block  th:replace="~{include/admin-sidebar :: sidebar(~{::content})}">
    <!--header breadcrumb area-->
    <div class="app__slide-wrapper" th:fragment="content">
        <div class="breadcrumb__area">
            <div class="breadcrumb__wrapper mb-35" style="padding: 0px;">
                <div class="breadcrumb__main">
                    <div class="breadcrumb__inner">
                        <div class="breadcrumb__icon">
                            <i class="flaticon-home"></i>
                        </div>
                        <div class="breadcrumb__menu">
                            <nav>
                                <ul>
                                    <li><span><a href="authenticate">Dashboard</a></span></li>
                                    <li class="active"><span>Manage Classroom</span></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                    <div class="search_add d-flex justify-content-between align-items-center">
                               <div class="new_class">
                                   <div class="breadcrum__button">
                                       <button class="element__btn  yellow-bg" data-bs-toggle="modal" data-bs-target="#newClassModal">
                                           Add Class +
                                       </button>
                                   </div>
                               </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--List Classroom-->
    <section th:fragment="content">
        <div class="flex-grow-1 p-4">
            <h5 class="classroom-title">Classroom List</h5>

            <!-- Table -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <input type="text" id="searchInput" class="form-control"
                               style="width: 250px; margin-right: 10px;"
                               placeholder="Search requirments..." onkeyup="filterTable()">
                        <button class="btn btn-outline-primary btn-sm" onclick="sortTable(0)">Sort by Name</button>
                        <button class="btn btn-outline-primary btn-sm mx-2" onclick="sortTable(1)">Sort by Number of Interns</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="sortTable(3)">Sort By Status</button>
                    </div>
                    <table id="classroomTable">
                        <thead>
                        <tr>
                            <th>Class Name</th>
                            <th>Number of Interns</th>
                            <th>Manager</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="table-content"></tbody>
                    </table>
                    <!--                        pagination-->
                    <div class="table-footer">
                        <div class="records-selector">
                            <span>Hiển thị</span>
                            <select class="records-per-page" style="width: 64px" onchange="changePageSize(this)">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                            <span>bản ghi</span>
                        </div>

                        <div class="pagination-container">
                            <ul id="pagination-list" class="pagination-list"></ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>


        <!-- Modal xác nhận khóa/mở khóa lớp -->
        <div class="modal fade" id="genericModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalMessage">Message here...</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary d-none" id="modalCancelBtn" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary d-none" id="modalConfirmBtn">Yes</button>
                        <button type="button" class="btn btn-success d-none" id="modalOkBtn" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editClassModal" tabindex="-1" aria-labelledby="editClassModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editClassModalLabel">Edit Class</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editClassForm">
                            <input type="hidden" id="editClassId"> <!-- Lưu ID của lớp -->

                            <div class="mb-3">
                                <label for="editClassName" class="form-label">Class Name</label>
                                <input type="text" class="form-control" id="editClassName" required>
                            </div>

                            <div class="mb-3">
                                <label for="editNumberOfInterns" class="form-label">Number of Interns</label>
                                <input type="number" class="form-control" id="editNumberOfInterns" required min="1">
                            </div>

                            <div class="mb-3">
                                <label for="editStatus" class="form-label">Status</label>
                                <select class="form-control" id="editStatus" required>
                                    <option value="NOT_STARTED">NOT_STARTED</option>
                                    <option value="ON_GOING">ON_GOING</option>
                                    <option value="ENDED">ENDED</option>
                                </select>
                            </div>

                            <label for="editManager">Select Manager:</label>
                            <select id="editManager" name="manager" class="form-control">
                                <option th:each="userRole : ${userRoleList}"
                                        th:value="${userRole.id}"
                                        th:text="${userRole.first_name + ' ' + userRole.last_name}">
                                </option>
                            </select>


                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="newClassModal" tabindex="-1" aria-labelledby="newClassModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="newClassModalLabel">Create a new Class</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="newClassForm">
                                <input type="hidden" id="newClassId">

                                <div class="mb-3">
                                    <label for="newClassName" class="form-label">Class Name</label>
                                    <input type="text" class="form-control" id="newClassName" required>
                                </div>

                                <div class="mb-3">
                                    <label for="newNumberOfInterns" class="form-label">Number of Interns</label>
                                    <input type="number" class="form-control" id="newNumberOfInterns" required min="1">
                                </div>

                                <label for="newManager">Select Manager:</label>
                                <select id="newManager" name="manager" class="form-control">
                                    <option th:each="userRole : ${userRoleList}"
                                            th:value="${userRole.id}"
                                            th:text="${userRole.first_name + ' ' + userRole.last_name}">
                                    </option>
                                </select>


                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Save a new class</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
    </section>
</th:block>
<footer th:replace="~{include/master-footer :: footer}"></footer>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        loadPage(0,5);
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
            searchInput.addEventListener('keyup', filterTable);
        }
    })

    document.addEventListener("click", function (event) {
        let icon = event.target.closest(".flaticon-padlock");
        if (!icon) return;

        event.preventDefault();
        event.stopPropagation();

        let classId = icon.getAttribute("data-id");
        if (!classId) {
            showModal("Error", "Missing class ID!");
            return;
        }

        let isUnlock = icon.classList.contains("inactive");
        let action = isUnlock ? "unlock" : "lock";
        let message = isUnlock ? "Are you sure you want to unlock this class?" : "Are you sure you want to lock this class?";

        showModal("Confirm", message, true, function () {
            toggleClassStatus(classId, action);
        });
    });

    function toggleClassStatus(classId, action) {
        let url = action === "unlock" ? `/api/class/setIsActiveTrue/${classId}` : `/api/class/delete/${classId}`;
        let method = action === "unlock" ? "PATCH" : "DELETE";

        fetch(url, { method: method })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(() => {
                let successMessage = action === "unlock" ? "Class has been unlocked!" : "Class has been locked!";
                showModal("Success", successMessage);

                let icon = document.querySelector(`.flaticon-padlock[data-id="${classId}"]`);
                if (icon) {
                    icon.classList.toggle("inactive");
                    icon.classList.toggle("active");
                }
            })
            .catch(error => showModal("Error", "Error: " + error.message));
    }

    function showModal(title, message, isConfirm = false, confirmCallback = null) {

        let modalTitle = document.getElementById("modalTitle");
        let modalMessage = document.getElementById("modalMessage");
        let confirmBtn = document.getElementById("modalConfirmBtn");
        let cancelBtn = document.getElementById("modalCancelBtn");
        let okBtn = document.getElementById("modalOkBtn");

        modalTitle.innerText = title;
        modalMessage.innerText = message;

        if (isConfirm) {
            confirmBtn.classList.remove("d-none");
            cancelBtn.classList.remove("d-none");
            okBtn.classList.add("d-none");

            confirmBtn.onclick = function () {
                confirmCallback();
                let modalInstance = bootstrap.Modal.getInstance(document.getElementById("genericModal"));
                modalInstance.hide();
            };
        } else {
            confirmBtn.classList.add("d-none");
            cancelBtn.classList.add("d-none");
            okBtn.classList.remove("d-none");
        }

        let modal = new bootstrap.Modal(document.getElementById("genericModal"));
        modal.show();
    }

// XỬ lý khi click vào nút newCLass
    document.addEventListener("click", function (event) {
        let newClassButton = event.target.closest(".new_class");
        if (!newClassButton) return;

        event.preventDefault();

        let addNewClassModal = new bootstrap.Modal(document.getElementById("newClassModal"));
        addNewClassModal.show();
    });

    document.getElementById("newClassForm").addEventListener("submit", function (event) {
        event.preventDefault();
        event.stopPropagation();

        let className = document.getElementById("newClassName").value;
        let numberOfIntern = document.getElementById("newNumberOfInterns").value;
        let managerId = document.getElementById("newManager").value;

        let requestData = {
            className: className,
            numberOfIntern: numberOfIntern,
            managerId: managerId
        };

        fetch(`/api/class/create`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(newClass => {
                let row = document.getElementById(`class-${newClass.id}`);
                if (row) {
                    row.children[0].textContent = newClass.className;
                    row.children[1].textContent = newClass.numberOfIntern;
                    row.children[2].setAttribute("data-manager-id", newClass.manager.id);
                    row.children[2].textContent = newClass.manager.firstName + " " + newClass.manager.lastName;
                }

                alert("Created a new class successfully!");
                let newClassModal = bootstrap.Modal.getInstance(document.getElementById("newClassModal"));
                newClassModal.hide();
                document.getElementById("newClassForm").reset();
            })
            .catch(error => alert("Error Create class: " + error.message));
    });

    // Xử lý khi click vào nút Edit
    document.addEventListener("click", function (event) {
        let editIcon = event.target.closest(".edit-class");
        if (!editIcon) return;
            event.preventDefault();

        let row = editIcon.closest("tr");
        if (!row) return;

        let classStatusElement = row.querySelector(".toggle-class-status");
        if (!classStatusElement) {
            alert("Error: Cannot find class ID.");
            return;
        }

        let classId = classStatusElement.getAttribute("data-id");
        if (!classId) {
            alert("Error: Class ID is missing.");
            return;
        }

        let className = row.children[0].textContent.trim();
        let numberOfIntern = row.children[1].textContent.trim();
        let status = row.children[3].textContent.trim();
        let rowId = row.id;
        let managerId = rowId.startsWith("manager-") ? rowId.split("-")[1] : null;

        if (!managerId) {
            alert("Error: Manager ID is missing.");
            return;
        }

        document.getElementById("editClassId").value = classId;
        document.getElementById("editClassName").value = className;
        document.getElementById("editNumberOfInterns").value = numberOfIntern;
        document.getElementById("editStatus").value = status;
        document.getElementById("editManager").value = managerId;


        let editModal = new bootstrap.Modal(document.getElementById("editClassModal"));
        editModal.show();
    });

    document.getElementById("editClassForm").addEventListener("submit", function (event) {
        event.preventDefault();
        event.stopPropagation();

        let classId = document.getElementById("editClassId").value;
        let className = document.getElementById("editClassName").value;
        let numberOfInterns = document.getElementById("editNumberOfInterns").value;
        let status = document.getElementById("editStatus").value;
        let managerId = document.getElementById("editManager").value;

        let requestData = {
            className: className,
            numberOfIntern: numberOfInterns,
            status: status,
            managerId: managerId
        };

        fetch(`/api/class/update/${classId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })

            .then(updatedClass => {
                alert("Class updated successfully!");
                location.reload();
            })
            .catch(error => alert("Error updating class: " + error.message));
    });

    function changePageSize(select) {
        pageSize = parseInt(select.value);
        loadPage(0, pageSize);
    }

    function loadPage(page, size) {
        fetch(`/api/class?page=${page}&size=${size}`)
            .then(response => response.json())
            .then(data => {
                totalPages = data.totalPages;
                currentPage = data.number;
                pageSize = data.size;
                renderTable(data.content);
                renderPagination();
            })
            .catch(error => console.error("Error fetching data:", error));
    }

    function renderTable(classes) {
        let tableContent = document.getElementById("table-content");
        tableContent.innerHTML='';
        tableContent.innerHTML = classes.map(c => `
        <tr id="manager-${c.manager.id}" data-class-id="${c.id}">
            <td>${c.className}</td>
            <td>${c.numberOfIntern}</td>
            <td>${c.manager.first_name} ${c.manager.last_name}</td>
            <td>${c.status}</td>
            <td>
                <a href="#" class="toggle-class-status open-modal" data-id="${c.id}">
                    <i class="${c.active ? 'flaticon-padlock active' : 'flaticon-padlock inactive'}" onclick="toggleActiveStatus(this, event)"></i>
                </a>
                <a href="#" class="edit-class-status">
                    <i class="flaticon-edit edit-class" style="cursor: pointer; color: blue;"></i>
                </a>
            </td>
        </tr>
    `).join('');
    }

    function renderPagination() {
        let pagination = document.getElementById("pagination-list");
        pagination.innerHTML = '';

        if (currentPage > 0) {
            pagination.innerHTML += `<li class="pagination-item"><a href="#" onclick="loadPage(${currentPage - 1}, ${pageSize})" class="pagination-link pagination-arrow">&#8249;</a></li>`;
        }

        for (let i = 0; i < totalPages; i++) {
            if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                pagination.innerHTML += `
            <li class="pagination-item ${i === currentPage ? 'active' : ''}">
                <a href="#" onclick="loadPage(${i}, ${pageSize})" class="pagination-link">${i + 1}</a>
            </li>`;
            }
        }

        if (currentPage < totalPages - 1) {
            pagination.innerHTML += `<li class="pagination-item"><a href="#" onclick="loadPage(${currentPage + 1}, ${pageSize})" class="pagination-link pagination-arrow">&#8250;</a></li>`;
        }
    }

    function filterTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let table = document.getElementById("table-content");
        let rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) {
            let cells = rows[i].getElementsByTagName("td");
            let match = false;

            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().includes(input)) {
                    match = true;
                    break;
                }
            }
            rows[i].style.display = match ? "" : "none";
        }
    }

    function sortTable(columnIndex) {
        let table = document.getElementById("table-content");
        let rows = Array.from(table.rows).slice(1);
        let isAscending = table.getAttribute("data-sort") !== "asc";

        rows.sort((rowA, rowB) => {
            let cellA = rowA.cells[columnIndex].textContent.trim().toLowerCase();
            let cellB = rowB.cells[columnIndex].textContent.trim().toLowerCase();

            if (!isNaN(cellA) && !isNaN(cellB)) {
                return isAscending ? cellA - cellB : cellB - cellA;
            } else {
                return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            }
        });

        rows.forEach(row => table.appendChild(row));
        table.setAttribute("data-sort", isAscending ? "asc" : "desc");
    }

</script>
</body>
</html>






