<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include/master-header :: head"></head>
<style>
    /*css pagination*/
    /* Records selector styling */
    .records-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
    }

    .records-per-page {
        height: 2.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        background-color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .table-footer {
        justify-content: space-between;
        display: flex;
        margin-top: 16px;
    }

    .records-per-page:focus {
        border-color: #3b82f6;
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
    }

    /* Pagination container */
    .pagination-container {
        display: flex;
        justify-content: flex-end;
    }

    .pagination-list {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    /* Pagination items */
    .pagination-item {
        display: inline-block;
    }

    .pagination-link {
        display: inline-flex;
        height: 2.25rem;
        min-width: 2.25rem;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        background-color: #fff;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        padding: 0 0.5rem;
    }

    .pagination-link:hover {
        background-color: #f3f4f6;
        border-color: #d1d5db;
    }

    /* Active page */
    .pagination-item.active .pagination-link {
        background-color: #f38321;
        color: white;
        border-color: #f38321;
    }

    .pagination-item.active .pagination-link:hover {
        background-color: #f38321;
    }

    /* Disabled pagination items */
    .pagination-item.disabled .pagination-link {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Arrow icons */
    .pagination-arrow {
        font-weight: bold;
    }


    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #f4f4f4;
    }

    .search__bar input {
        margin-right: auto;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 500px;
    }
    .breadcrum__button{
        display: flex;
        padding-left: 25px;
    }
    .search__bar input {
        border: 1px solid #ccc;
        border-radius: 15px;
        width: 400px;
        height: fit-content;
    }

    /* Toast Notification Styles */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: white;
        color: #333;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        display: none;
        min-width: 300px;
        border-left: 4px solid #ff6600;
        animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
    }

    .toast-content {
        display: flex;
        align-items: center;
    }

    .toast-icon {
        color: #ff6600;
        font-size: 22px;
        margin-right: 15px;
    }

    .toast-message {
        font-size: 14px;
        font-weight: 500;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
            display: none;
        }
    }
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.6); /* Tối màu nền hơn */
    }

    .records-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
    }

    .table-footer {
        justify-content: space-between;
        display: flex;
        margin-top: 16px;
    }

    .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 30px;
        border-radius: 16px;
        width: 80%;
        max-width: 900px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    @keyframes modalopen {
        from {opacity: 0; transform: translate(-50%, -60%);}
        to {opacity: 1; transform: translate(-50%, -50%);}
    }

    .close-modal {
        position: absolute;
        right: 5px;
        top: 0;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close-modal:hover {
        color: #ff6600;
    }

    .requirement-row {
        cursor: pointer;
    }

    .requirement-row:hover {
        background-color: #f8f9fa;
    }

    /* Additional styles for content inside modal */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .search-bar {
        display: flex;
        gap: 10px;
    }

    .search-input {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 50px;
        width: 300px;
    }

    .btn-primary {
        background-color: #ff6600;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 50px;
        cursor: pointer;
    }

    .skills-container {
        max-height: none;
        overflow-y: visible;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        padding-right: 0;
    }

    .skill-pill {
        background-color: rgba(255, 102, 0, 0.1);
        color: #ff6600;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        margin-bottom: 3px;
        display: inline-block;
        white-space: nowrap;
    }

    .gpa {
        font-weight: bold;
        color: #333;
    }

    .gpa-high {
        color: #28a745;
    }

    .gpa-medium {
        color: #fd7e14;
    }

    .gpa-low {
        color: #dc3545;
    }

    /* Button styling */
    button {
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        font: inherit;
        cursor: pointer;
        outline: inherit;
    }

    .action-icons {
        display: flex;
        gap: 8px;
        justify-content: center;
    }

    .pagination-container {
        display: flex;
        justify-content: flex-end;
    }

    .pagination-list {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .pagination-item {
        display: inline-block;
    }

    .pagination-link {
        display: inline-flex;
        height: 2.25rem;
        min-width: 2.25rem;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        background-color: #fff;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        padding: 0 0.5rem;
    }

    .pagination-link:hover {
        background-color: #f3f4f6;
        border-color: #d1d5db;
    }

    /* Active page */
    .pagination-item.active .pagination-link {
        background-color: #f38321;
        color: white;
        border-color: #f38321;
    }

    .pagination-item.active .pagination-link:hover {
        background-color: #f38321;
    }

    /* Disabled pagination items */
    .pagination-item.disabled .pagination-link {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Arrow icons */
    .pagination-arrow {
        font-weight: bold;
    }

    .action-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid;
        font-size: 14px;
    }

    .check-icon {
        color: #28a745;
        border-color: #28a745;
        background-color: white;
    }

    .check-icon:hover {
        background-color: rgba(40, 167, 69, 0.1);
    }

    .x-icon {
        color: #dc3545;
        border-color: #dc3545;
        background-color: white;
    }

    /* Hover styles */
    .action-icon:hover {
        transform: translateY(-2px);
    }

    /* Shadow effect for sidebar when modal is open */
    .modal-open .sidebar {
        pointer-events: none;
    }

    .modal-open .app__slide-wrapper {
        pointer-events: none;
    }

    /* Modal table styling */
    .modal .table {
        margin-bottom: 0;
        width: 100%;
        table-layout: fixed;
    }

    .modal .table th {
        position: sticky;
        top: 0;
        z-index: 10;
        font-weight: 600;
        background-color: #f8f9fa;
        border-top: none;

    }

    .modal .table-container {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        max-height: 65vh;
        overflow-y: auto;
    }

    .pagination-container {
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .pagination .page-item .page-link {
        color: #ff6600;
        border-color: #ddd;
        background-color: #fff;
        transition: all 0.2s ease;
    }

    .pagination .page-item.active .page-link {
        color: #fff;
        background-color: #ff6600;
        border-color: #ff6600;
    }

    .pagination .page-item .page-link:hover {
        background-color: #f8f9fa;
        color: #ff6600;
        border-color: #ddd;
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #ddd;
    }

    /* Điều chỉnh padding các thành phần trong modal */
    .modal .card {
        margin-top: 10px;
    }

    .modal .header {
        margin-bottom: 10px;
    }

    .modal h3 {
        font-size: 1.4rem;
        margin-bottom: 0;
    }

    .modal .table th,
    .modal .table td {
        padding: 8px 10px;
        font-size: 0.9rem;
    }

    .search-input {
        padding: 6px 12px;
        font-size: 0.9rem;
    }

    .btn-primary {
        padding: 6px 15px;
        font-size: 0.9rem;
    }

    .skill-pill {
        padding: 2px 8px;
        font-size: 0.8rem;
    }

    .action-icon {
        width: 30px;
        height: 30px;
    }

    /* Điều chỉnh độ rộng các cột */
    .modal .table th:nth-child(1),
    .modal .table td:nth-child(1) {
        width: 18%;
    }

    .modal .table th:nth-child(2),
    .modal .table td:nth-child(2) {
        width: 8%;
    }

    .modal .table th:nth-child(3),
    .modal .table td:nth-child(3) {
        width: 20%;
    }

    .modal .table th:nth-child(4),
    .modal .table td:nth-child(4) {
        width: 34%;  /* Thêm chiều rộng cho cột skills */
    }

    .modal .table th:nth-child(5),
    .modal .table td:nth-child(5) {
        width: 10%;
        white-space: nowrap;
        text-align: center;
    }

    .modal .table th:nth-child(6),
    .modal .table td:nth-child(6) {
        width: 12%;
        text-align: center;
    }

    /* Tối ưu hiển thị text dài */
    .modal .table td {
        white-space: normal;
        word-break: break-word;
    }

    /* Làm cho phân trang nhỏ gọn hơn */
    .pagination-container {
        margin-top: 10px;
        margin-bottom: 5px;
    }

    .pagination .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    /* Điều chỉnh chiều cao của các hàng */
    .modal .table tr {
        min-height: 60px;
    }

    /* Cải thiện hiển thị skills */
    .modal .table td:nth-child(4) {
        padding-top: 12px;
        padding-bottom: 12px;
    }

    .skills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        width: 100%;
    }

    .skill-pill {
        background-color: rgba(255, 102, 0, 0.1);
        color: #ff6600;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: inline-block;
        white-space: nowrap;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .skill-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }

    .x-icon:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }

    .modal-backdrop {
        display: none;
    }
    /* Additional styles for the requirement form */
    #requirementForm label {
        font-weight: 500;
        margin-bottom: 5px;
        display: block;
    }

    #requirementForm .form-control {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        width: 100%;
    }

    #requirementForm .form-control:focus {
        border-color: #ff6600;
        box-shadow: 0 0 0 0.2rem rgba(255, 102, 0, 0.25);
    }

    /* Make sure the modal is on top of everything */
    #addRequirementModal {
        z-index: 10000;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        #addRequirementModal .modal-content {
            width: 90%;
        }
    }

    /* Spinner for loading state */
    .fa-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
<body class="body-area">
<th:block  th:replace="~{include/admin-sidebar :: sidebar(~{::content})}">
    <!--header breadcrumb area-->
    <div class="app__slide-wrapper" th:fragment="content">
        <div class="breadcrumb__area">
            <div class="breadcrumb__wrapper mb-35" style="padding: 0px;">
                <div class="breadcrumb__main">
                    <div class="breadcrumb__inner">
                        <div class="breadcrumb__icon">
                            <i class="flaticon-home"></i>
                        </div>
                        <div class="breadcrumb__menu">
                            <nav>
                                <ul>
                                    <li><span><a href="authenticate">Dashboard</a></span></li>
                                    <li class="active"><span>Manage Requirement</span></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                    <div class="search_add d-flex justify-content-between align-items-center">
                        <div class="new_class">
                            <div class="breadcrum__button">
                                <button class="element__btn  yellow-bg" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    Add Recruitment +
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- insert custom content here -->
    <section th:fragment="content">
        <div class="flex-grow-1 p-4">
            <h3 style="font-weight: bold">Recruitment List</h3>
            <!-- Table -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <input type="text" id="searchInput" class="form-control"
                               style="width: 250px; margin-right: 10px;"
                               placeholder="Search requirments..." onkeyup="filterTable()">
                        <button class="btn btn-outline-primary btn-sm" onclick="sortTable(0)">Sort by Name</button>
                        <button class="btn btn-outline-primary btn-sm mx-2" onclick="sortTable(1)">Sort by Position</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="sortTable(4)">Sort By GPA</button>

                        <!-- Selected rows action buttons -->
                        <div id="selectedActions" class="ms-auto" style="display: none;">
                            <span class="me-2">Selected: <span id="selectedCount">0</span></span>
                            <button class="btn btn-danger btn-sm">Delete Selected</button>
                        </div>
                    </div>
                    <table id="recruitmentTable" class="table table-striped">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Position</th>
                            <th>Experience Requirement</th>
                            <th>Language</th>
                            <th>Min GPA</th>
                            <th>End Time</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="table-content"></tbody>
                    </table>
                    <div class="table-footer">
                        <div class="records-selector">
                            <span>Show</span>
                            <select class="records-per-page" style="width: 64px" onchange="changePageSize(this)">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                            <span>record</span>
                        </div>
                        <div class="pagination-container">
                            <ul id="pagination-list" class="pagination-list">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Candidate Modal -->
        <div id="candidateModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <div class="header">
                    <h3 id="modalTitle">Candidate List</h3>
                    <div class="search-bar">
                        <div class="d-flex gap-2 align-items-center">
                            <input type="text" id="searchCandidateInput" class="search-input"
                                   placeholder="Search candidates...">
                            <button class="btn btn-primary" id="searchCandidateButton">Search</button>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>GPA</th>
                                <th>Education</th>
                                <th>Skills</th>
                                <th>Gender</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody id="candidateTableBody">
                            <!-- Candidate data will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Recruitment Modal -->
        <div class="modal fade" id="editRecruitmentModal" tabindex="-1" aria-labelledby="editRecruitmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editRecruitmentModalLabel">Edit Recruitment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editRecruitmentForm">
                            <input type="hidden" id="editRecruitmentId">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editName" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="editName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="editPosition" class="form-label">Position</label>
                                    <input type="text" class="form-control" id="editPosition" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editExperienceRequirement" class="form-label">Experience Requirement</label>
                                    <input type="text" class="form-control" id="editExperienceRequirement" placeholder="e.g., 1 year">
                                </div>
                                <div class="col-md-6">
                                    <label for="editLanguage" class="form-label">Language</label>
                                    <input type="text" class="form-control" id="editLanguage" placeholder="e.g., English, Japanese">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editMinGPA" class="form-label">Minimum GPA</label>
                                    <input type="number" step="0.1" min="0" max="4.0" class="form-control" id="editMinGPA" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="editTotalSlot" class="form-label">Total Slots</label>
                                    <input type="number" min="1" class="form-control" id="editTotalSlot" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editEndTime" class="form-label">End Time</label>
                                <input type="date" class="form-control" id="editEndTime" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveRecruitmentChanges">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteRecruitmentModal" tabindex="-1" aria-labelledby="deleteRecruitmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteRecruitmentModalLabel">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this recruitment? This action cannot be undone.</p>
                        <p><strong>Recruitment: </strong><span id="deleteRecruitmentName"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteRecruitment">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Requirement Modal -->
        <div id="addRequirementModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeAddRequirementModal()">×</span>
                <div class="header">
                    <h3>Create Requirement</h3>
                </div>

                <form id="requirementForm">
                    <div class="form-group mb-3">
                        <label for="requirementName">Requirement Name</label>
                        <input type="text" class="form-control" id="requirementName" name="name" placeholder="Enter requirement name" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="position">Position</label>
                        <input type="text" class="form-control" id="position" name="position" placeholder="Enter position" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Enter requirement description"></textarea>
                    </div>

                    <div class="form-group mb-3">
                        <label for="experienceRequirement">Experience Requirement <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="experienceRequirement" name="experienceRequirement" rows="2" placeholder="Describe experience requirements" required></textarea>
                        <small class="text-muted">This field is required and cannot be empty.</small>
                    </div>

                    <div class="form-group mb-3">
                        <label for="language">Language <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="language" name="language" placeholder="Required languages (e.g., English, Japanese)" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="minGPA">Minimum GPA <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="minGPA" name="minGPA" placeholder="Minimum GPA required" step="0.1" min="0" max="4.0" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="totalSlot">Total Slot <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="totalSlot" name="totalSlot" placeholder="Number of available positions" min="1" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="endTime">End Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="endTime" name="endTime" required>
                    </div>

                    <!-- Thêm khung lựa chọn classId -->
                    <div class="form-group mb-3">
                        <label for="classId">Classroom <span class="text-danger">*</span></label>
                        <select class="form-control" id="classId" name="classId" required>
                            <option value="">Select a Classroom</option>
                            <!-- Options sẽ được điền bằng JavaScript -->
                        </select>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-secondary me-2" onclick="closeAddRequirementModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveButton" style="background-color: #ff6600; border-color: #ff6600;">Save</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Toast Notification -->
        <div id="toastNotification" class="toast-notification">
            <div class="toast-content">
                <i class="fas fa-check-circle toast-icon"></i>
                <div class="toast-message" id="toastMessage">Notification message</div>
            </div>
        </div>
    </section>
</th:block>
<footer th:replace="~{include/master-footer :: footer}"></footer>
<script>
    // Function to fetch Classrooms and populate the select
    function populateClassroomSelect() {
        fetch('/api/class/all') // Fetch từ endpoint /api/classrooms/all
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch classrooms');
                }
                return response.json();
            })
            .then(classrooms => {
                const classSelect = document.getElementById('classId');
                classSelect.innerHTML = '<option value="">Select a Classroom</option>'; // Reset options
                classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.id;
                    option.textContent = classroom.className || `Class ${classroom.id}`; // Hiển thị name hoặc id
                    classSelect.appendChild(option);
                });
            })
            .catch(error => {
                const classSelect = document.getElementById('classId');
                classSelect.innerHTML = '<option value="">Error loading classrooms</option>';
            });
    }

    // Function to open the Add Requirement modal
    function openAddRequirementModal() {
        const modal = document.getElementById("addRequirementModal");
        if (!modal) {
            return;
        }
        modal.style.display = "block";
        document.body.classList.add('modal-open');

        // Set default values
        const endDateInput = document.getElementById("endTime");
        const thirtyDaysLater = new Date();
        thirtyDaysLater.setDate(thirtyDaysLater.getDate() + 30);
        endDateInput.value = thirtyDaysLater.toISOString().split('T')[0];

        document.getElementById("totalSlot").value = 1;
        document.getElementById("minGPA").value = 2.5;
        document.getElementById("experienceRequirement").value = "No experience required";
        document.getElementById("language").value = "English";

        // Fetch và điền danh sách classrooms khi mở modal
        populateClassroomSelect();
    }
    // Function to close the Add Requirement modal
    function closeAddRequirementModal() {
        const modal = document.getElementById("addRequirementModal");
        if (modal) {
            modal.style.display = "none";
            document.body.classList.remove('modal-open');
            document.getElementById("requirementForm").reset();
        }
    }


    // Đóng modal khi click ra ngoài nội dung modal
    window.addEventListener("click", function (event) {
        const modal = document.getElementById("addRequirementModal");
        if (event.target === modal) {
            closeAddRequirementModal();
        }
    });


    // Function to validate form data
    function validateFormData(formDataObj) {
        const errors = [];

        // Validate minGPA
        const minGPA = parseFloat(formDataObj.minGPA);
        if (isNaN(minGPA) || minGPA < 0 || minGPA > 4) {
            errors.push("Min GPA must be a number between 0.0 and 4.0");
        }

        // Validate totalSlot
        const totalSlot = parseInt(formDataObj.totalSlot);
        if (isNaN(totalSlot) || totalSlot <= 0) {
            errors.push("Total Slot must be a positive integer greater than 0");
        }

        // Validate endTime
        const endTime = new Date(formDataObj.endTime);
        const now = new Date();
        if (isNaN(endTime.getTime()) || endTime <= now) {
            errors.push("End Time must be a valid date in the future");
        }

        return errors;
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById("requirementForm");
        if (!form) {
            return;
        }

        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const saveButton = document.getElementById("saveButton");
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            const formData = new FormData(form);
            const formDataObj = {};
            formData.forEach((value, key) => {
                formDataObj[key] = value;
            });

            // Đảm bảo các field mặc định
            formDataObj.experience = formDataObj.experience || "No experience required";
            formDataObj.description = formDataObj.description || "No description provided";

            // Validate dữ liệu
            const validationErrors = validateFormData(formDataObj);
            if (validationErrors.length > 0) {
                showToast("Validation errors: " + validationErrors.join(", "), "error");
                saveButton.disabled = false;
                saveButton.innerHTML = 'Save';
                return;
            }


            fetch('/api/recruitment/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formDataObj)
            })
                .then(response => {
                    return response.text().then(text => {
                        if (!response.ok) {
                            throw new Error(text || 'Failed to create requirement');
                        }
                        return text ? JSON.parse(text) : { success: true, message: "Requirement created successfully" };
                    });
                })
                .then(data => {
                    showToast("Requirement added successfully!", "success");
                    closeAddRequirementModal();
                    setTimeout(() => window.location.reload(), 1500);
                })
                .catch(error => {
                    showToast("Error: " + error.message, "error");
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save';
                });
        });
    });

    // Update the existing "Add Requirement +" button
    document.addEventListener('DOMContentLoaded', function() {
        const addButton = document.querySelector(".element__btn.yellow-bg");
        if (addButton) {
            addButton.removeAttribute("data-bs-toggle");
            addButton.removeAttribute("data-bs-target");
            addButton.onclick = openAddRequirementModal;
        }
    });

    // Make sure DOM is fully loaded before accessing elements
    document.addEventListener('DOMContentLoaded', function() {
        loadPage(0, 5);
        // Fix table reference in filter function
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
            searchInput.addEventListener('keyup', filterTable);
        }
    });
    // Thêm xử lý tìm kiếm ứng viên
    function setupCandidateSearch() {
        const searchButton = document.getElementById('searchCandidateButton');
        const searchInput = document.getElementById('searchCandidateInput');

        searchButton.addEventListener('click', function() {
            searchCandidates();
        });

        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchCandidates();
            }
        });
    }

    function searchCandidates() {
        const searchTerm = document.getElementById('searchCandidateInput').value.toLowerCase().trim();

        if (!window.allCandidates) {
            return;
        }

        // Nếu không có từ khóa tìm kiếm, hiển thị tất cả
        if (!searchTerm) {
            displayCandidates(window.allCandidates, window.currentRecruitmentId);
            return;
        }

        // Lọc danh sách ứng viên theo từ khóa
        const filteredCandidates = window.allCandidates.filter(candidate => {
            return (
                (candidate.name && candidate.name.toLowerCase().includes(searchTerm)) ||
                (candidate.education && candidate.education.toLowerCase().includes(searchTerm)) ||
                (candidate.skill && candidate.skill.toLowerCase().includes(searchTerm))
            );
        });

        // Hiển thị kết quả tìm kiếm
        if (filteredCandidates.length === 0) {
            const tableBody = document.getElementById("candidateTableBody");
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No candidates found matching your search criteria</td></tr>';

            // Xóa phân trang nếu có
            const existingPagination = document.getElementById('candidatePagination');
            if (existingPagination) {
                existingPagination.remove();
            }
        } else {
            displayCandidates(filteredCandidates, window.currentRecruitmentId);
        }
    }

    function openCandidateModal(row) {
        // Get the data from the clicked row
        const name = row.cells[0].textContent;
        const position = row.cells[1].textContent;
        const recruitmentId = row.getAttribute('data-id');

        const modal = document.getElementById("candidateModal");
        const modalTitle = document.getElementById("modalTitle");
        modalTitle.textContent = name + " - " + position + " Candidates";

        // Load candidates
        loadCandidates(recruitmentId);

        // Set up search functionality
        setupCandidateSearch();

        // Add blur effect to sidebar and content
        document.body.classList.add('modal-open');

        // Display the modal
        modal.style.display = "block";

        // Prevent event bubbling
        event.stopPropagation();
    }

    function closeModal() {
        const modal = document.getElementById("candidateModal");
        modal.style.display = "none";

        // Remove blur effect
        document.body.classList.remove('modal-open');
    }

    function loadCandidates(recruitmentId) {
        // Fetch CV_Info data from the server based on the recruitment ID
        const tableBody = document.getElementById("candidateTableBody");
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading candidates...</td></tr>';

        // Call the API to get CV_Info data
        fetch('/api/cv-info/recruitment/' + recruitmentId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch candidates: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                displayCandidates(data, recruitmentId);
            })
            .catch(error => {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading candidates: ' + error.message + '</td></tr>';

                // For demo purposes, load sample data if API fails
                setTimeout(() => {
                    loadSampleCandidates(recruitmentId);
                }, 1000);
            });
    }

    function loadSampleCandidates(recruitmentId) {
        const sampleCandidates = [
            {
                name: "John Doe",
                gpa: 3.8,
                education: "Computer Science, FPT University",
                skill: "Java, Spring Boot, React",
                gender: "MALE",
                fileId: 1,
                recruitmentId: recruitmentId
            },
            {
                name: "Jane Smith",
                gpa: 3.5,
                education: "Information Technology, FPT University",
                skill: "Python, Django, SQL",
                gender: "FEMALE",
                fileId: 2,
                recruitmentId: recruitmentId
            },
            {
                name: "Alex Johnson",
                gpa: 3.2,
                education: "Software Engineering, FPT University",
                skill: "JavaScript, Node.js, Vue",
                gender: "MALE",
                fileId: 3,
                recruitmentId: recruitmentId
            }
        ];
        displayCandidates(sampleCandidates, recruitmentId);
    }

    function displayCandidates(candidates, recruitmentId) {
        const tableBody = document.getElementById("candidateTableBody");
        tableBody.innerHTML = "";

        candidates = candidates.filter(candidate => candidate.isActive !== false);

        if (!candidates || candidates.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No candidates found for this requirement</td></tr>';
            return;
        }

        // Thêm biến phân trang - thay đổi từ 10 xuống 5
        const pageSize = 5;
        const totalCandidates = candidates.length;
        const totalPages = Math.ceil(totalCandidates / pageSize);
        let currentPage = 1;

        // Lưu toàn bộ dữ liệu ứng viên vào biến toàn cục để sử dụng khi chuyển trang
        window.allCandidates = candidates;
        window.currentRecruitmentId = recruitmentId;

        // Hiển thị chỉ 5 ứng viên của trang hiện tại
        displayCandidatesPage(currentPage, pageSize, recruitmentId);

        // Tạo phân trang nếu có nhiều hơn 5 ứng viên
        if (totalCandidates > pageSize) {
            createPagination(totalPages, currentPage);
        }

        // Thêm thông báo trạng thái cho người dùng
        addCandidateStatusMessage(recruitmentId);
    }

    function displayCandidatesPage(page, pageSize, recruitmentId) {
        const tableBody = document.getElementById("candidateTableBody");
        tableBody.innerHTML = "";

        // Lấy danh sách ứng viên cho trang hiện tại
        const startIndex = (page - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, window.allCandidates.length);
        const candidatesForPage = window.allCandidates.slice(startIndex, endIndex);

        candidatesForPage.forEach(candidate => {
            const row = document.createElement("tr");

            // Name
            const nameCell = document.createElement("td");
            nameCell.textContent = candidate.name || "Unknown";
            row.appendChild(nameCell);

            // GPA
            const gpaCell = document.createElement("td");
            const gpaSpan = document.createElement("span");
            gpaSpan.textContent = candidate.gpa;

            if (candidate.gpa >= 3.7) {
                gpaSpan.className = "gpa gpa-high";
            } else if (candidate.gpa >= 3.0) {
                gpaSpan.className = "gpa gpa-medium";
            } else {
                gpaSpan.className = "gpa gpa-low";
            }

            gpaCell.appendChild(gpaSpan);
            row.appendChild(gpaCell);

            // Education
            const eduCell = document.createElement("td");
            eduCell.textContent = candidate.education || "Not specified";
            row.appendChild(eduCell);

            // Skills
            const skillsCell = document.createElement("td");
            const skillsContainer = document.createElement("div");
            skillsContainer.className = "skills-container";

            // Split the skills string into an array
            let skills = [];
            if (typeof candidate.skill === 'string') {
                skills = candidate.skill.split(',').map(s => s.trim()).filter(s => s);
            }

            // Nếu không có kỹ năng, thêm thông báo
            if (skills.length === 0) {
                const pill = document.createElement("span");
                pill.className = "skill-pill";
                pill.style.backgroundColor = "#f8f9fa";
                pill.style.color = "#6c757d";
                pill.textContent = "No skills specified";
                skillsContainer.appendChild(pill);
            } else {
                skills.forEach(skill => {
                    const pill = document.createElement("span");
                    pill.className = "skill-pill";
                    pill.textContent = skill;
                    skillsContainer.appendChild(pill);
                });
            }

            skillsCell.appendChild(skillsContainer);
            row.appendChild(skillsCell);

            // Gender
            const genderCell = document.createElement("td");
            genderCell.textContent = candidate.gender || "MALE";
            row.appendChild(genderCell);

            // Actions
            const actionCell = document.createElement("td");

            // Create action icons container
            const actionIcons = document.createElement("div");
            actionIcons.className = "action-icons";

            // Create accept button
            const acceptButton = document.createElement("button");
            acceptButton.className = "action-icon check-icon";
            acceptButton.title = "Approve Candidate";
            acceptButton.innerHTML = '<i class="fas fa-solid fa-check"></i>';
            acceptButton.onclick = function() {
                approveCandidate(candidate.fileId, recruitmentId);
            };

            // Create reject button
            const rejectButton = document.createElement("button");
            rejectButton.className = "action-icon x-icon";
            rejectButton.title = "Reject Candidate";
            rejectButton.innerHTML = '<i class="fas fa-times"></i>';
            rejectButton.onclick = function() {
                rejectCandidate(candidate.fileId, recruitmentId);
            };

            // Add buttons to container
            actionIcons.appendChild(acceptButton);
            actionIcons.appendChild(rejectButton);

            // Add container to cell
            actionCell.appendChild(actionIcons);

            // Add cell to row
            row.appendChild(actionCell);

            // Add row to table
            tableBody.appendChild(row);
        });
    }

    function rejectCandidate(fileId, recruitmentId) {
        // First, get user info by fileId
        fetch(`/file/${fileId}/user`, {
            method: 'GET'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user information');
                }
                return response.json();
            })
            .then(userData => {
                const userEmail = userData.email; // Giả sử User object có field email

                // Call API to reject the candidate
                return fetch(`/api/cv-info/reject?fileId=${fileId}&recruitmentId=${recruitmentId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(text || 'Failed to reject candidate');
                            });
                        }
                        return response.text();
                    })
                    .then(data => {
                        showToast('Candidate rejected successfully!', 'success');

                        // Reload candidates data
                        loadCandidates(recruitmentId);

                        // Send email notification
                        return fetch("/api/email/send-mail", {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({
                                recipient: userEmail,  // Sử dụng email lấy được từ user
                                msgBody: "Chào bạn, Trước hết rất không vui khi phải thông báo rằng hồ sơ của bạn đã không được thông qua. Hẹn bạn 1 lần khác ở công ty chúng tôi. Xin cảm ơn",
                                subject: "Hồ sơ của bạn đã không được chấp nhận",
                                attachment: null
                            })
                        });
                    });
            })
            .then(emailResponse => {
                if (emailResponse && !emailResponse.ok) {
                    throw new Error('Failed to send email');
                }
            })
            .catch(error => {

                showToast('Error: ' + error.message, 'error');
            });
    }

    function createPagination(totalPages, currentPage) {
        // Xóa phân trang cũ nếu có
        const existingPagination = document.getElementById('candidatePagination');
        if (existingPagination) {
            existingPagination.remove();
        }

        // Tạo container cho phân trang
        const paginationContainer = document.createElement('div');
        paginationContainer.id = 'candidatePagination';
        paginationContainer.className = 'pagination-container mt-3 d-flex justify-content-center';

        // Tạo ul element cho nút phân trang
        const paginationList = document.createElement('ul');
        paginationList.className = 'pagination';

        // Nút Previous
        const prevLi = document.createElement('li');
        prevLi.className = 'page-item ' + (currentPage === 1 ? 'disabled' : '');
        const prevLink = document.createElement('a');
        prevLink.className = 'page-link';
        prevLink.href = '#';
        prevLink.textContent = 'Previous';
        prevLink.onclick = function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        };
        prevLi.appendChild(prevLink);
        paginationList.appendChild(prevLi);

        // Tạo các nút số trang
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Điều chỉnh lại startPage nếu cần
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = 'page-item ' + (i === currentPage ? 'active' : '');
            const pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '#';
            pageLink.textContent = i;
            pageLink.onclick = function(e) {
                e.preventDefault();
                goToPage(i);
            };
            pageLi.appendChild(pageLink);
            paginationList.appendChild(pageLi);
        }

        // Nút Next
        const nextLi = document.createElement('li');
        nextLi.className = 'page-item ' + (currentPage === totalPages ? 'disabled' : '');
        const nextLink = document.createElement('a');
        nextLink.className = 'page-link';
        nextLink.href = '#';
        nextLink.textContent = 'Next';
        nextLink.onclick = function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        };
        nextLi.appendChild(nextLink);
        paginationList.appendChild(nextLi);

        // Thêm phân trang vào container
        paginationContainer.appendChild(paginationList);

        // Thêm vào DOM sau bảng
        const cardElement = document.querySelector('.modal .card');
        cardElement.appendChild(paginationContainer);
    }

    function goToPage(page) {
        // Cập nhật trang hiện tại và hiển thị lại dữ liệu
        window.currentPage = page;
        displayCandidatesPage(page, 5, window.currentRecruitmentId);

        // Cập nhật UI phân trang
        const totalPages = Math.ceil(window.allCandidates.length / 5);
        createPagination(totalPages, page);
    }

    function approveCandidate(fileId, recruitmentId) {
        // First, get user info by fileId
        fetch(`/file/${fileId}/user`, {
            method: 'GET'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user information');
                }
                return response.json();
            })
            .then(userData => {
                const userEmail = userData.email; // Giả sử User object có field email

                // Call API to approve the candidate
                return fetch(`/api/cv-info/approve?fileId=${fileId}&recruitmentId=${recruitmentId}`, {
                    method: 'POST'
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                if(data.success === false && data.message === "User has been approved into another class") {
                                    showToast(data.message, 'warning');
                                    throw new Error(data.message);
                                }
                                throw new Error(data.error || 'Failed to approve candidate');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {

                        // Show toast notification for success
                        showToast('Candidate approved successfully!', 'success');

                        // Remove the approved candidate from the list without reloading
                        removeApprovedCandidate(fileId);

                        // Send email notification
                        return fetch("/api/email/send-mail", {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({
                                recipient: userEmail,  // Sử dụng email lấy được từ user
                                msgBody: "Chào bạn ,chúc mừng bạn đã qua được vòng phỏng vấn xin vui lòng đến công ty vào ngày mai để nhận công việc.Xin cảm ơn..",
                                subject: "Hồ sơ của bạn đã được thông qua",
                                attachment: null
                            })
                        });
                    });
            })
            .then(emailResponse => {
                if (emailResponse && !emailResponse.ok) {
                    throw new Error('Failed to send email');
                }
            })
            .catch(error => {
                if(error.message !== "User has been approved into another class") {
                    showToast('Error: ' + error.message, 'error');
                }
            });
    }

    /**
     * Shows a toast notification
     * @param {string} message - The message to display
     * @param {string} type - The type of toast ('success' or 'error')
     */
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toastNotification');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = toast.querySelector('.toast-icon');

        // Set message
        toastMessage.textContent = message;

        // Set appropriate icon and color based on type
        if (type === 'success') {
            toastIcon.className = 'fas fa-check-circle toast-icon';
            toast.style.borderLeftColor = '#28a745';
            toastIcon.style.color = '#28a745';
        } else if (type === 'error') {
            toastIcon.className = 'fas fa-exclamation-circle toast-icon';
            toast.style.borderLeftColor = '#dc3545';
            toastIcon.style.color = '#dc3545';
        } else if (type === 'warning') {
            toastIcon.className = 'fas fa-exclamation-triangle toast-icon';
            toast.style.borderLeftColor = '#fd7e14';
            toastIcon.style.color = '#fd7e14';
        }

        // Show the toast
        toast.style.display = 'block';

        // Reset the animation
        toast.style.animation = 'none';
        toast.offsetHeight; // Trigger reflow
        toast.style.animation = 'slideIn 0.3s, fadeOut 0.5s 2.5s forwards';

        // Hide the toast after 3 seconds
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    /**
     * Xóa ứng viên đã được approve khỏi danh sách hiển thị
     */
    function removeApprovedCandidate(fileId) {
        // Xóa ứng viên khỏi danh sách toàn cục
        if (window.allCandidates) {
            window.allCandidates = window.allCandidates.filter(candidate => candidate.fileId != fileId);

            // Cập nhật lại danh sách hiển thị
            const pageSize = 5;
            const totalCandidates = window.allCandidates.length;
            const totalPages = Math.ceil(totalCandidates / pageSize);

            // Kiểm tra nếu trang hiện tại lớn hơn tổng số trang sau khi xóa
            if (window.currentPage > totalPages && totalPages > 0) {
                window.currentPage = totalPages;
            } else if (totalPages === 0) {
                window.currentPage = 1;
            }

            // Cập nhật hiển thị
            displayCandidatesPage(window.currentPage || 1, pageSize, window.currentRecruitmentId);

            // Cập nhật phân trang
            if (totalCandidates > pageSize) {
                createPagination(totalPages, window.currentPage || 1);
            } else {
                // Xóa phân trang nếu không đủ ứng viên
                const existingPagination = document.getElementById('candidatePagination');
                if (existingPagination) {
                    existingPagination.remove();
                }
            }

            // Hiển thị thông báo nếu không còn ứng viên
            if (totalCandidates === 0) {
                const tableBody = document.getElementById("candidateTableBody");
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No candidates found for this requirement</td></tr>';
            }
        }
    }

    function renderPagination() {
        let pagination = document.getElementById("pagination-list");
        pagination.innerHTML = '';

        if (currentPage > 0) {
            pagination.innerHTML += `<li class="pagination-item"><a href="#" onclick="loadPage(${currentPage - 1}, ${pageSize})" class="pagination-link pagination-arrow">&#8249;</a></li>`;
        }

        for (let i = 0; i < totalPages; i++) {
            if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                pagination.innerHTML += `
            <li class="pagination-item ${i === currentPage ? 'active' : ''}">
                <a href="#" onclick="loadPage(${i}, ${pageSize})" class="pagination-link">${i + 1}</a>
            </li>`;
            }
        }

        if (currentPage < totalPages - 1) {
            pagination.innerHTML += `<li class="pagination-item"><a href="#" onclick="loadPage(${currentPage + 1}, ${pageSize})" class="pagination-link pagination-arrow">&#8250;</a></li>`;
        }
    }

    function loadPage(page, size) {
        fetch(`/api/recruitment?page=${page}&&size=${size}`)
            .then(response => response.json())
            .then(data => {
                totalPages = data.totalPages;
                currentPage = data.number;
                pageSize = data.size;
                renderTable(data.content);
                renderPagination();
            })
    }

    function filterTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let table = document.getElementById("table-content");
        let rows = table.getElementsByTagName("tr");

        for (let i = 0; i < rows.length; i++) {
            let cells = rows[i].getElementsByTagName("td");
            let match = false;

            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().includes(input)) {
                    match = true;
                    break;
                }
            }
            rows[i].style.display = match ? "" : "none";
        }
    }

    function sortTable(columnIndex) {
        let table = document.getElementById("table-content");
        let rows = Array.from(table.rows).slice(0);
        let isAscending = table.getAttribute("data-sort") !== "asc";

        rows.sort((rowA, rowB) => {
            let cellA = rowA.cells[columnIndex].textContent.trim().toLowerCase();
            let cellB = rowB.cells[columnIndex].textContent.trim().toLowerCase();

            if (!isNaN(cellA) && !isNaN(cellB)) {
                return isAscending ? cellA - cellB : cellB - cellA;
            } else {
                return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            }
        });

        rows.forEach(row => table.appendChild(row));
        table.setAttribute("data-sort", isAscending ? "asc" : "desc");
    }

    function renderTable(requirements) {
        let tableContent = document.getElementById("table-content");
        tableContent.innerHTML = '';
        tableContent.innerHTML = requirements.map(r => `
        <tr class="requirement-row" onclick="openCandidateModal(this)" data-id="${r.id}">
            <td>${r.name}</td>
            <td>${r.position}</td>
            <td>${r.experienceRequirement}</td>
            <td>${r.language}</td>
            <td>${r.minGPA}</td>
            <td>${new Date (r.endTime).toLocaleDateString('en-GB')}</td>
            <td>
                <a href="#" data-id="${r.id}" class="edit-recruitment-modal"
                   onclick="openEditRecruitmentModal(this, event)">
                    <i class="flaticon-edit" style="cursor: pointer"></i>
                </a>
                <a href="#" data-id="${r.id}" class="delete-recruitment-modal"
                   onclick="confirmDeleteRecruitment(this, event)">
                    <i class="flaticon-padlock" style="cursor: pointer; color: red"></i>
                </a>
            </td>
        </tr>
    `).join('');
    }

    function changePageSize(select) {
        pageSize = parseInt(select.value);
        loadPage(0, pageSize);
    }

    // Close modal when clicking outside the modal content
    window.onclick = function(event) {
        const modal = document.getElementById("candidateModal");
        if (event.target === modal) {
            closeModal();
        }
    }

    // Thêm thông báo về trạng thái hiển thị CV
    function addCandidateStatusMessage(recruitmentId) {
        // Xóa thông báo cũ nếu có
        const existingMessage = document.getElementById('candidateStatusMessage');
        if (existingMessage) {
            existingMessage.remove();
        }

        // Tạo phần tử thông báo
        const messageDiv = document.createElement('div');
        messageDiv.id = 'candidateStatusMessage';
        messageDiv.className = 'alert alert-info mt-2';
        messageDiv.style.fontSize = '0.9rem';
        messageDiv.innerHTML = '<i class="fas fa-info-circle"></i> Only showing CV candidates that have not been approved yet.';

        // Thêm vào DOM
        const modalCard = document.querySelector('.modal .card');
        modalCard.parentNode.insertBefore(messageDiv, modalCard);
    }

    let recruitmentToDelete = null

    // Function to open the edit recruitment modal
    function openEditRecruitmentModal(element, event) {
        event.stopPropagation() // Prevent row click event

        const recruitmentId = element.getAttribute("data-id")

        // Fetch recruitment details
        fetch(`/api/recruitment/${recruitmentId}`)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Failed to fetch recruitment details")
                }
                return response.json()
            })
            .then((recruitment) => {
                // Populate the form fields
                document.getElementById("editRecruitmentId").value = recruitment.id
                document.getElementById("editName").value = recruitment.name
                document.getElementById("editPosition").value = recruitment.position
                document.getElementById("editExperienceRequirement").value = recruitment.experienceRequirement || ""
                document.getElementById("editLanguage").value = recruitment.language || ""
                document.getElementById("editMinGPA").value = recruitment.minGPA
                document.getElementById("editTotalSlot").value = recruitment.totalSlot

                // Format date for the date input (YYYY-MM-DD)
                const endDate = new Date(recruitment.endTime)
                const formattedDate = endDate.toISOString().split("T")[0]
                document.getElementById("editEndTime").value = formattedDate

                // Show the modal
                const editModal = new bootstrap.Modal(document.getElementById("editRecruitmentModal"))
                editModal.show()
            })
            .catch((error) => {
                showToast("Error loading recruitment details!", "error");
            })
    }

    // Function to save recruitment changes
    function saveRecruitmentChanges() {
        const recruitmentId = document.getElementById("editRecruitmentId").value

        // Create recruitment object from form data
        const recruitment = {
            id: recruitmentId,
            name: document.getElementById("editName").value,
            position: document.getElementById("editPosition").value,
            experienceRequirement: document.getElementById("editExperienceRequirement").value,
            language: document.getElementById("editLanguage").value,
            minGPA: Number.parseFloat(document.getElementById("editMinGPA").value),
            totalSlot: Number.parseInt(document.getElementById("editTotalSlot").value),
            endTime: document.getElementById("editEndTime").value,
        }

        // Send update request
        fetch(`/api/recruitment/update/${recruitmentId}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(recruitment),
        })
            .then((response) => {
                if (!response.ok) {
                    return response.text().then((text) => {
                        throw new Error(text || "Failed to update recruitment")
                    })
                }
                return response.json()
            })
            .then((data) => {
                // Close the modal
                const editModalElement = document.getElementById("editRecruitmentModal")
                const editModal = bootstrap.Modal.getInstance(editModalElement)
                editModal.hide()

                // Show success message
                showToast("Recruitment updated successfully!", "success");

                // Reload the page to show updated data
                window.location.reload()
            })
            .catch((error) => {
                showToast("Error updating recruitment", "error");
            })
    }

    // Function to open delete confirmation modal
    function confirmDeleteRecruitment(element, event) {
        event.stopPropagation() // Prevent row click event

        recruitmentToDelete = element.getAttribute("data-id")

        // Get the recruitment name from the table row
        const row = element.closest("tr")
        const recruitmentName = row.cells[0].textContent

        // Set the recruitment name in the confirmation modal
        document.getElementById("deleteRecruitmentName").textContent = recruitmentName

        // Show the modal
        const deleteModal = new bootstrap.Modal(document.getElementById("deleteRecruitmentModal"))
        deleteModal.show()
    }

    // Function to delete recruitment
    function deleteRecruitment() {
        if (!recruitmentToDelete) {
            alert("No recruitment selected for deletion")
            return
        }

        // Send delete request
        fetch(`/api/recruitment/delete/${recruitmentToDelete}`, {
            method: "DELETE",
        })
            .then((response) => {
                if (!response.ok) {
                    return response.text().then((text) => {
                        throw new Error(text || "Failed to delete recruitment")
                    })
                }
                return response.text()
            })
            .then((data) => {
                // Close the modal
                const deleteModalElement = document.getElementById("deleteRecruitmentModal")
                const deleteModal = bootstrap.Modal.getInstance(deleteModalElement)
                deleteModal.hide()

                showToast("Recruitment deleted successfully!", "success");

                // Reload the page to update the table
                window.location.reload()
            })
            .catch((error) => {
                alert("Error deleting recruitment: " + error.message)
            })
    }

    // Add event listeners when the DOM is loaded
    document.addEventListener("DOMContentLoaded", () => {
        // Save changes button in edit modal
        const saveChangesBtn = document.getElementById("saveRecruitmentChanges")
        if (saveChangesBtn) {
            saveChangesBtn.addEventListener("click", saveRecruitmentChanges)
        }

        // Confirm delete button in delete modal
        const confirmDeleteBtn = document.getElementById("confirmDeleteRecruitment")
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener("click", deleteRecruitment)
        }
    })

</script>
</body>
</html>