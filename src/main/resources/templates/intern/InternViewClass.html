<!doctype
        html >
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include/master-header :: head">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classroom Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
    }

    .search-bar {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 8px 12px;
    }

    .filter-btn {
      border: 1px solid #e67e22;
      color: #e67e22;
      background-color: transparent;
      border-radius: 20px;
      padding: 4px 12px;
      margin-right: 8px;
      font-size: 14px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .filter-btn:hover {
      background-color: #e67e22;
      color: white;
    }

    .card {
      border-radius: 8px;
      border: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 15px;
    }

    .sidebar-card {
      background-color: #f0f2f5;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sidebar-card:hover {
      background-color: #e9ecef;
    }

    .sidebar-card.active {
      background-color: #e9ecef;
      border-left: 3px solid #e67e22;
    }

    .gamma-header {
      color: #e67e22;
      font-size: 24px;
      font-weight: bold;
    }

    .content-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      padding: 20px;
      max-height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 50px); /* Mở rộng tối đa */
      overflow: hidden; /* Loại bỏ scroll từ container */
    }

    .main-content {
      max-height: calc(100vh - 50px);
      min-height: 100%;
      overflow-y: auto;
    }

    .error-tag {
      background-color: #fff2e6;
      color: #e67e22;
      border: 1px solid #e67e22;
      border-radius: 15px;
      padding: 2px 10px;
      font-size: 12px;
      display: inline-block;
    }

    .chat-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .green-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: green;
      border-radius: 50%;
      margin-right: 5px;
    }

    .student-list {
      list-style-type: none;
      padding-left: 0;
    }

    .student-list li {
      margin-bottom: 8px;
    }

    .date-picker {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 6px 12px;
      background-color: white;
    }

    .chat-message {
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 15px;
      height: 80vh;
    }

    .chat-header {
      background: #f8f9fa;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }

    .chat-input {
      padding: 10px;
      border-top: 1px solid #ddd;
    }

    .filters-container {
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 10px;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .filters-container::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .filters-container {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .detail-placeholder {
      display: flex;
      height: 100%;
      align-items: center;
      justify-content: center;
      color: #aaa;
      font-size: 18px;
    }

    .red-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: red;
      border-radius: 50%;
      margin-right: 5px;
    }

    .yellow-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #ffb700;
      border-radius: 50%;
      margin-right: 5px;
    }

    .student-badge {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 50px;
      border: 1px solid #20c997;
      background-color: #fff;
      color: #333;
      font-size: 14px;
      white-space: nowrap;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5); /* Làm nền tối hơn */
      backdrop-filter: blur(8px); /* Làm mờ nền */
      display: none;
    }

    .modal {
      backdrop-filter: blur(8px); /* Làm mờ nền phía sau */
      background: rgba(0, 0, 0, 0.2); /* Thêm một lớp tối nhẹ */
    }

    .modal-content{
      margin-top: 150px;
    }

    .task-item {
      position: relative;
      padding: 18px 22px;
      border-radius: 10px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      transition: all 0.3s ease-in-out;
      border-left: 5px solid #ff923a; /* Mặc định màu cam */
      cursor: pointer;
    }

    /* Hiệu ứng khi di chuột vào */
    .task-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Chỉnh màu sắc theo độ ưu tiên */
    .task-item.high {
      border-left-color: #e74c3c;
      background-color: #ffebee;
    }

    .task-item.medium {
      border-left-color: #f1c40f;
      background-color: #fff8e1;
    }

    .task-item.low {
      border-left-color: #2ecc71;
      background-color: #e8f5e9;
    }

    /* Tiêu đề task */
    .task-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    /* Nội dung mô tả */
    .task-description {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    /* Footer của task */
    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #999;
    }

    /* Nút hành động */
    .task-actions {
      display: flex;
      gap: 8px;
    }

    .task-actions button {
      border: none;
      background: none;
      cursor: pointer;
      padding: 5px;
      transition: color 0.2s ease-in-out;
    }

    .task-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    /* Tiêu đề danh sách công việc */
    .task-list-header h5 {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }

    /* Nút Thêm Công Việc */
    .add-task-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      background-color: #ff790e;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
    }

    .add-task-btn i {
      font-size: 16px;
    }

    /* Hiệu ứng hover */
    .add-task-btn:hover {
      background-color: #ffae6b;
      transform: translateY(-2px);
    }

    /* Hiệu ứng khi bấm vào */
    .add-task-btn:active {
      background-color: #1a5f8c;
      transform: scale(0.98);
    }

    /* Custom scrollbar styles for better UX */
    .student-container::-webkit-scrollbar,
    .task-list::-webkit-scrollbar,
    .content-card::-webkit-scrollbar {
      width: 6px;
    }

    .student-container::-webkit-scrollbar-track,
    .task-list::-webkit-scrollbar-track,
    .content-card::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .student-container::-webkit-scrollbar-thumb,
    .task-list::-webkit-scrollbar-thumb,
    .content-card::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 10px;
    }

    .student-container::-webkit-scrollbar-thumb:hover,
    .task-list::-webkit-scrollbar-thumb:hover,
    .content-card::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }

    /* Nền mờ khi mở modal */
    .task-detail-modal {
      display: none; /* Ẩn mặc định */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* Mờ nền */
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease-in-out;
    }

    /* Nội dung modal */
    .task-detail-content {
      background: white;
      width: 50%;
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
      padding: 20px;
      position: relative;
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Hiệu ứng mở modal */
    @keyframes fadeIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Nút đóng modal */
    .task-detail-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #333;
    }

    .task-detail-close:hover {
      color: red;
    }

    /* Header của modal */
    .task-detail-header {
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 15px;
      text-align: center;
    }

    /* Phần thân modal */
    .task-detail-body {
      font-size: 16px;
    }

    /* Danh sách bài nộp */
    .submission-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }

    .task-list {
      max-height: 500px; /* Giới hạn chiều cao của danh sách task */
      overflow-y: auto;  /* Cho phép cuộn dọc */
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); /* Thêm bóng nhẹ cho task list */
    }

    /* Khi cuộn đến cuối cùng, task cuối cùng sẽ được hiển thị */
    .task-list:after {
      content: '';
      display: block;
      height: 1px;
      width: 100%;
      background-color: transparent;
    }

    /* Tăng cường khả năng cuộn mượt mà */
    .task-list {
      scroll-behavior: smooth; /* Cuộn mượt mà */
    }

    .student-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      max-height: 150px; /* Limit height to enable scrolling */
      overflow-y: auto; /* Enable vertical scrolling */
      padding: 5px;
      border-radius: 8px;
    }

    .student-card {
      transition: transform 0.2s ease-in-out;
    }

    .student-card:hover {
      transform: scale(1.03);
    }

    .mentor-details:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    #classDetails {
      min-height: 600px; /* Tăng chiều cao tối thiểu để chứa toàn bộ nội dung */
      height: auto; /* Đảm bảo chiều cao tự động mở rộng nếu nội dung dài hơn */
      display: flex;
      flex-direction: column;
    }

    /* Reset container heights to allow proper content display */
    .content-card {
      max-height: none !important; /* Remove fixed height restriction */
      height: auto !important; /* Allow height to expand with content */
      overflow: visible !important; /* Allow content to be fully visible */
      display: flex;
      flex-direction: column;
    }

    /* Fix class details container */
    #classDetails {
      min-height: 600px; /* Minimum height to accommodate content */
      height: auto !important; /* Override any fixed height */
      display: flex;
      flex-direction: column;
      overflow: visible !important; /* Ensure content is not cut off */
    }

    /* Fix task list container */
    #task-list, .task-list {
      max-height: 500px; /* Reasonable max height */
      overflow-y: auto !important; /* Enable vertical scrolling */
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding-bottom: 30px !important; /* Extra padding at the bottom */
      position: relative; /* For absolute positioning of children if needed */
    }

    /* Add space after the last item */
    #task-list:after, .task-list:after {
      content: "";
      display: block;
      height: 30px; /* Extra space after the last item */
      width: 100%;
      clear: both;
    }

    /* Ensure task items have proper spacing */
    .task-item {
      position: relative;
      padding: 18px 22px;
      border-radius: 10px;
      background-color: #ffffff;
      margin-bottom: 15px !important; /* Ensure consistent spacing between items */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      transition: all 0.3s ease-in-out;
      border-left: 5px solid #ff923a;
      cursor: pointer;
      display: block; /* Ensure block display */
      clear: both; /* Clear any floats */
    }

    /* Last task item needs extra margin */
    .task-item:last-child {
      margin-bottom: 30px !important; /* Extra margin for the last item */
    }

    /* Improve scrollbar styling for better visibility */
    #task-list::-webkit-scrollbar,
    .task-list::-webkit-scrollbar {
      width: 8px;
    }

    #task-list::-webkit-scrollbar-track,
    .task-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    #task-list::-webkit-scrollbar-thumb,
    .task-list::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    #task-list::-webkit-scrollbar-thumb:hover,
    .task-list::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Fix row and column containers */
    .row {
      height: auto !important;
      overflow: visible !important;
    }

    .col-md-8 {
      height: auto !important;
      overflow: visible !important;
    }

    /* Ensure main content area has proper scrolling */
    .main-content {
      max-height: none !important; /* Remove max height restriction */
      min-height: 100%;
      overflow-y: visible !important; /* Allow content to be fully visible */
    }

    /* Fix task list wrapper if it exists */
    .tasks-wrapper {
      padding-bottom: 20px; /* Add padding to the bottom of the wrapper */
    }
    /* Additional CSS for Task Detail Modal */
    .modal-header {
      background-color: #007bff;
      color: white;
    }

    .modal-title {
      font-weight: bold;
    }

    #task-name {
      font-size: 1.25rem;
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 0.5rem;
    }

    .task-dates {
      background-color: #f8f9fa;
      border-left: 3px solid #007bff;
    }

    #task-file-container {
      background-color: #f8f9fa;
      border-left: 3px solid #28a745;
    }

    #task-file-link {
      color: #007bff;
      text-decoration: none;
    }

    #task-file-link:hover {
      text-decoration: underline;
    }

    .submission-form {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 0.25rem;
      border: 1px solid #dee2e6;
    }

    .submission-form h6 {
      font-weight: bold;
      margin-bottom: 1rem;
    }

    #submission-history {
      margin-top: 2rem;
    }

    #submission-history h6 {
      font-weight: bold;
      margin-bottom: 1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .task-dates .row > div {
        margin-bottom: 1rem;
      }
    }
    /* Fix for Firefox scrolling */
    @-moz-document url-prefix() {
      #task-list, .task-list {
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
      }
    }

    /* Fix for IE scrolling */
    #task-list, .task-list {
      -ms-overflow-style: -ms-autohiding-scrollbar;
    }

    /* Ensure proper spacing in the task meta section */
    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #999;
      margin-top: 10px;
    }

    /* Fix for mobile devices */
    @media (max-width: 768px) {
      #task-list, .task-list {
        max-height: 400px; /* Slightly smaller on mobile */
      }

      .content-card {
        height: auto !important;
        max-height: none !important;
      }

      #classDetails {
        min-height: 400px;
      }
    }
    /* Đảm bảo phần tử cha không giới hạn chiều cao */
    .col-md-8 {
      height: auto;
    }

    .row {
      height: auto;
    }

    /* Tùy chỉnh thanh cuộn (nếu cần) */
    #task-list::-webkit-scrollbar {
      width: 8px;
    }

    #task-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    #task-list::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    #task-list::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Style cho global alert container */
    #globalAlertContainer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 15px;
      z-index: 9999; /* Increase from 1055 to 9999 to ensure it's above all other elements */
    }

    #globalAlertContainer .alert {
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 10px;
      animation: alert-in 0.3s ease forwards;
    }

    #globalAlertContainer .alert-danger {
      border-left: 4px solid #dc3545;
    }

    #globalAlertContainer .alert-warning {
      border-left: 4px solid #ffc107;
    }

    #globalAlertContainer .alert-success {
      border-left: 4px solid #28a745;
    }

    #globalAlertContainer .alert-info {
      border-left: 4px solid #17a2b8;
    }
    .task-item.expired {
      position: relative;
      border-left-color: #dc3545;
      background-color: #f8d7da;
    }

    .expired-indicator {
      position: absolute;
      top: -10px;
      right: 10px;
      background-color: #dc3545; /* Màu đỏ */
      color: white;
      padding: 4px 12px; /* Tăng padding để chữ lớn hơn */
      border-radius: 12px; /* Bo góc mềm mại hơn */
      font-size: 14px; /* Tăng kích thước chữ */
      font-weight: bold;
      z-index: 1;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Thêm bóng để nổi bật */
      animation: pulse 2s infinite; /* Thêm hiệu ứng nhấp nháy */
    }

    /* Hiệu ứng nhấp nháy */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Mentor comment styles */
    .mentor-comment {
      background-color: #f0f8ff;
      border-left: 3px solid #0d6efd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;

    }

    .mentor-comment-header {
      font-weight: bold;
      margin-bottom: 5px;
      color: #0d6efd;
    }

    /* Modal z-index adjustments */
    .modal {
      z-index: 1050;
    }

    #globalAlertContainer {
      z-index: 1060 !important;
    }

    @keyframes alert-in {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body class="body-area">
<input type="hidden" id="user_id" th:value="${internID}" value="STU001">
<input type="hidden" id="class_Id" th:value="${classId}" value="CLS001">
<input type="hidden" id="user_avatar" value="https://randomuser.me/api/portraits/women/44.jpg">
<th:block th:replace="~{include/employee-sidebar :: sidebar(~{::content})}">
  <div class="app__slide-wrapper" th:fragment="content">
    <div class="breadcrumb__area">
      <div class="breadcrumb__wrapper mb-35" style="padding: 0px;">
        <div class="breadcrumb__main">
          <div class="breadcrumb__inner">
            <div class="breadcrumb__icon">
              <i class="flaticon-home"></i>
            </div>
            <div class="breadcrumb__menu">
              <nav>
                <ul>
                  <li style="margin-bottom: 20px; margin-top: 20px"><span>Dashboard</span></li>
                  <li class="active"><span>Classroom</span></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Class Details (Moved back to the left) -->
      <div class="col-md-8">
        <div class="content-card" id="classDetails">
          <div id="loading-indicator" class="text-center py-4">
            <div class="spinner-border text-warning" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Đang tải dữ liệu lớp học...</p>
          </div>
          <div id="error-message" class="alert alert-danger" style="display: none;">
            Không thể tải dữ liệu lớp học. Vui lòng thử lại sau.
          </div>
          <div id="class-content" style="display: none;">
            <div class="gamma-header mb-3" id="className">Tên lớp học</div>
            <div class="text-muted mb-4" id="classTime">Thời gian</div>

            <!-- Framed Mentor Section without Avatar -->
            <div class="mentor-info">
              <div style="
    position: relative;
    width: 100%;
    max-width: 320px;
    padding: 20px;
    border-radius: 16px;
    border: 2px solid #f5f5f5;
    background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    transition: all 0.3s ease;
    margin-bottom: 20px;
  ">
                <!-- Decorative circles -->
                <div style="
      position: absolute;
      top: -50px;
      right: -50px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.03);
      transition: transform 0.5s ease;
    "></div>
                <div style="
      position: absolute;
      bottom: -50px;
      left: -50px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.03);
      transition: transform 0.5s ease;
    "></div>

                <!-- Content container -->
                <div style="
      display: flex;
      align-items: center;
      position: relative;
      z-index: 1;
    ">
                  <!-- Text content (no avatar) -->
                  <div style="display: flex; flex-direction: column;">
                    <div style="
          font-size: 12px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 1px;
          color: #666;
          margin-bottom: 4px;
        ">Mentor</div>
                    <div id="mentorName" style="
          font-size: 20px;
          font-weight: 600;
          color: #333;
          transition: color 0.3s ease;
        ">Tên mentor</div>
                    <div style="
          height: 3px;
          width: 48px;
          background-color: #ff9800;
          border-radius: 2px;
          margin-top: 8px;
        "></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <h5 id="task-header" class="mb-3">Danh sách Task</h5>
              <div id="task-list" class="task-list">
                <div class="text-center py-2">
                  <div class="spinner-border spinner-border-sm text-warning" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <span>Đang tải danh sách task...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Box (Moved back to the right) -->
      <div class="col-md-4" id="chatContainer">
      </div>
    </div>

    <!-- Task Detail Modal (unchanged) -->
    <!-- Task Detail Modal -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <!-- Header with centered text -->
          <div class="modal-header">
            <h5 class="modal-title w-100 text-center fw-bold" id="taskDetailModalLabel">Chi tiết Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Task Name -->
            <h5 id="task-name" class="fw-bold mb-4">Tên Task</h5>

            <!-- Task Dates -->
            <div class="task-dates p-3 bg-light rounded mb-4">
              <div class="row">
                <div class="col-md-6">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-calendar me-2 text-primary"></i>
                    <div>
                      <strong>Thời gian bắt đầu:</strong>
                      <span id="task-start-time" class="ms-2">01/01/2023 08:00</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-clock me-2 text-danger"></i>
                    <div>
                      <strong>Hạn nộp:</strong>
                      <span id="task-end-time" class="ms-2 text-danger">15/01/2023 23:59</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- File Attachment -->
            <div id="task-file-container" class="mb-4 p-3 bg-light rounded">
              <div class="d-flex align-items-center">
                <i class="bi bi-paperclip me-2 text-primary"></i>
                <strong>Tệp đính kèm:</strong>
                <a href="#" id="task-file-link" class="ms-2">
                  <i class="bi bi-file-earmark-text me-1"></i>
                  <span id="task-file-name">file.pdf</span>
                </a>
              </div>
            </div>

            <!-- Description -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-info-circle me-2 text-primary"></i>
                <strong>Mô tả:</strong>
              </div>
              <p id="task-description" class="p-3 border rounded">Mô tả task sẽ hiển thị ở đây.</p>
            </div>

            <!-- Link (if needed) -->
            <div id="task-link-container" class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-link-45deg me-2 text-primary"></i>
                <strong>Link:</strong>
              </div>
              <p id="task-link" class="p-3 border rounded">Mô tả task sẽ hiển thị ở đây.</p>
            </div>

            <!-- Keeping the original submission form as requested -->
            <div class="submission-form">
              <h6>Nộp bài</h6>
              <form id="submission-form">
                <div class="mb-3">
                  <label for="submission-file" class="form-label">Tệp đính kèm</label>
                  <input type="file" class="form-control" id="submission-file">
                </div>

                <button type="submit" class="btn btn-primary" id="submit-task-btn">Nộp bài</button>
              </form>
            </div>

            <!-- Keeping the original submission history as requested -->
            <div id="submission-history" class="mt-4">
              <h6>Lịch sử nộp bài</h6>
              <div id="submission-list">
                <!-- Submission history will be loaded here -->
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Thêm Global Alert Container -->
    <div id="globalAlertContainer" class="position-fixed bottom-0 end-0 p-3"></div>
  </div>
</th:block>
<footer th:replace="~{include/master-footer :: footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/messenger.js"></script>
<script>
  // Global variables
  var user_id = document.getElementById("user_id").value;
  let internId = null;
  let classId = null;

  // Hàm hiển thị thông báo toàn cục
  function showGlobalAlert(message, type = 'danger') {
    const alertContainer = document.getElementById('globalAlertContainer');
    if (!alertContainer) {
      console.error('Global alert container not found!');
      return;
    }

    // Ensure the container has the highest z-index
    alertContainer.style.zIndex = '9999';

    // Generate a unique ID for the alert
    const alertId = 'alert-' + Date.now();

    // Set icon based on type
    let icon = 'bi-exclamation-triangle-fill';
    if (type === 'success') icon = 'bi-check-circle-fill';
    else if (type === 'warning') icon = 'bi-exclamation-circle-fill';
    else if (type === 'info') icon = 'bi-info-circle-fill';

    // Create the alert HTML
    const alertHtml = `
    <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert" style="border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 4px solid;">
      <i class="bi ${icon} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;

    // Append the alert to the container
    alertContainer.innerHTML += alertHtml;

    // Set border-left color based on type
    const alertElement = document.getElementById(alertId);
    if (alertElement) {
      const borderColor = {
        'danger': '#dc3545',
        'warning': '#ffc107',
        'success': '#28a745',
        'info': '#17a2b8'
      }[type] || '#dc3545';
      alertElement.style.borderLeftColor = borderColor;

      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alertElement);
        bsAlert.close();
      }, 5000);

      // Scroll to the alert
      alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }


  // Initialize the page
  document.addEventListener("DOMContentLoaded", function() {
    // Get the intern ID from the hidden input
    const userIdElement = document.getElementById("user_id");
    const classroom =document.getElementById("class_Id")
    if (userIdElement && userIdElement.value) {
      internId = userIdElement.value;
      classId = classroom.value;
      console.log("User ID from input:", internId);
      console.log("class_Id ID from input :", classId);
      loadClassData(classId);
    } else {
      // Fallback to example ID for testing
      internId = "203";
      console.log("Using fallback intern ID:", internId);

      // Load the intern's class with mock data
      loadInternClass();
    }
    fixTaskListDisplay();

    // Also call after a short delay to ensure all content is loaded
    setTimeout(fixTaskListDisplay, 1000);

    // Call again after tasks are loaded
    const originalFetchTasks = window.fetchTasks;
    if (originalFetchTasks) {
      window.fetchTasks = (classId) => {
        originalFetchTasks(classId).then(() => {
          setTimeout(fixTaskListDisplay, 500);
        });
      };
    }
    // Set up event listeners
    const sendMessageBtn = document.getElementById("sendMessageBtn");
    if (sendMessageBtn) {
      sendMessageBtn.addEventListener("click", sendMessage);
    }

    const messageInput = document.getElementById("message");
    if (messageInput) {
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });
      ensureModalZIndex();
    }
    function ensureModalZIndex() {
      // Set global alert container to highest z-index
      const alertContainer = document.getElementById('globalAlertContainer');
      if (alertContainer) {
        alertContainer.style.zIndex = '1060';
      }

      // Adjust modal backdrop z-index
      const style = document.createElement('style');
      style.innerHTML = `
      .modal-backdrop {
        z-index: 1040 !important;
      }
      .modal {
        z-index: 1050 !important;
      }
      #globalAlertContainer {
        z-index: 9999 !important;
      }
    `;
      document.head.appendChild(style);
    }

    const submissionForm = document.getElementById("submission-form");
    if (submissionForm) {
      submissionForm.addEventListener("submit", (e) => {
        e.preventDefault();
        submitTask();
      });
    }

    // Add this new function call
    fixModalZIndexes();

    // Existing code...
  });

  // Add this new function
  function fixModalZIndexes() {
    // Add a style element to ensure proper z-index hierarchy
    const style = document.createElement('style');
    style.textContent = `
    .modal-backdrop {
      z-index: 1040 !important;
    }
    .modal {
      z-index: 1050 !important;
    }
    #globalAlertContainer {
      z-index: 9999 !important;
    }
  `;
    document.head.appendChild(style);

    // Also set the z-index directly on the container element
    const alertContainer = document.getElementById('globalAlertContainer');
    if (alertContainer) {
      alertContainer.style.zIndex = '9999';
    }
  }

  // Function to load students for a class
  function loadStudents(classId) {
    console.log("Loading students for class ID:", classId);

    fetch(`/api/class/${classId}/users`)
            .then(response => {
              if (!response.ok) {
                throw new Error('Không thể lấy danh sách sinh viên từ server');
              }
              return response.json();
            })
            .then(students => {
              console.log("Students retrieved:", students);
              displayStudents(students);
            })
            .catch(error => {
              console.error("Lỗi khi lấy danh sách sinh viên:", error);
              // Fall back to mock data if API fails
            });
  }

  // Function to fetch tasks for the class
  async function fetchTasks(classId) {
    try {
      console.log("Fetching tasks for class ID:", classId);

      const taskList = document.getElementById("task-list");
      // Show loading indicator in the task list
      if (taskList) {
        taskList.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-warning me-2" role="status"></div>
                    <span>Đang tải danh sách task...</span>
                </div>
            `;
      }

      // Fetch tasks from API
      const response = await fetch(`/api/class/task/${classId}`);

      // Check if the request was successful
      if (!response.ok) {
        throw new Error(`Failed to fetch tasks: ${response.status} ${response.statusText}`);
      }

      // Parse the JSON response
      const tasks = await response.json();
      console.log("Tasks API Response:", tasks);

      // Render the tasks
      renderTasksNewDesign(tasks);

    } catch (error) {
      console.error("Error fetching tasks:", error);
      const taskList = document.getElementById("task-list");
      if (taskList) {
        taskList.innerHTML = `
                <div class="alert alert-danger">
                    Không thể tải danh sách task. Vui lòng thử lại sau.
                </div>
            `;
      }

      // Fall back to mock data if API fails
      setTimeout(() => {
        renderTasksNewDesign(mockTasks);
      }, 1000);
    }
  }

  // Function to fix the task list display
  function fixTaskListDisplay() {
    const taskList = document.getElementById("task-list");
    const contentCard = document.querySelector(".content-card");
    const classDetails = document.getElementById("classDetails");

    if (taskList && contentCard && classDetails) {
      // Remove fixed height constraints
      contentCard.style.maxHeight = "none";
      contentCard.style.height = "auto";
      contentCard.style.overflow = "visible";

      // Ensure class details has proper height
      classDetails.style.minHeight = "600px";
      classDetails.style.height = "auto";

      // Ensure task list has proper scrolling
      taskList.style.maxHeight = "500px";
      taskList.style.overflowY = "auto";
      taskList.style.paddingBottom = "30px";

      // Add a spacer at the end of the task list if it doesn't exist
      if (!taskList.querySelector('.task-list-spacer')) {
        const spacer = document.createElement("div");
        spacer.className = "task-list-spacer";
        spacer.style.height = "20px";
        spacer.style.width = "100%";
        taskList.appendChild(spacer);
      }

      console.log("Task list display fixed");
    }
  }

  // Function to render tasks with the new design


  function renderTasksNewDesign(tasks) {
    const taskListElement = document.getElementById("task-list");
    if (!taskListElement) {
      console.error("Task list element not found");
      return;
    }

    taskListElement.innerHTML = "";

    if (!tasks || tasks.length === 0) {
      taskListElement.innerHTML = '<div class="text-muted">Không có công việc nào</div>';
      return;
    }

    // Create a wrapper div to ensure proper spacing
    const tasksWrapper = document.createElement("div");
    tasksWrapper.className = "tasks-wrapper";

    // Process each task
    tasks.forEach(task => {
      try {
        // Format dates
        const startTime = new Date(task.startTime);
        const endTime = new Date(task.endTime);
        const currentTime = new Date();

        // Check if task has expired
        const isExpired = currentTime > endTime;

        const formattedStartTime = startTime.toLocaleString("vi-VN", {
          hour: '2-digit',
          minute: '2-digit',
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });

        const formattedEndTime = endTime.toLocaleString("vi-VN", {
          hour: '2-digit',
          minute: '2-digit',
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });

        // Create task element
        const taskElement = document.createElement("div");
        taskElement.className = `task-item ${isExpired ? 'expired' : ''}`;
        taskElement.dataset.taskId = task.id;
        taskElement.dataset.expired = isExpired;

        // Add expired indicator if needed
        let statusIndicator = '';
        if (isExpired) {
          statusIndicator = '<div class="expired-indicator">Đã hết hạn</div>';
        }

        // Add the task content first (we'll check submission status later)
        taskElement.innerHTML = `
        ${statusIndicator}
        <div class="task-title">${task.taskName || 'Unnamed Task'}</div>
        <div class="task-description">${task.description || 'Không có mô tả nào'}</div>
        <div class="task-meta">
          <div>Bắt đầu: ${formattedStartTime}</div>
          <div class="task-deadline">Hạn nộp: ${formattedEndTime}</div>
        </div>
      `;

        // Add click event to open task detail modal
        taskElement.addEventListener("click", () => {
          openTaskDetailModal(task);
        });

        // Add to the wrapper
        tasksWrapper.appendChild(taskElement);

        // Now check submission status asynchronously and update the task element if needed
        if (!isExpired) {
          // Use a self-executing async function to handle the submission check
          (async () => {
            try {
              // Load submission history for this task
              const submission = await loadSubmissionHistory2(task.id);
              console.log(`Submission for task ${task.id}:`, submission);

              if (submission) {
                let notificationHTML = '';

                // Check if there's a comment but no mark
                if (submission.comment && submission.mark === null) {
                  notificationHTML = `
                  <div class="expired-indicator" style="
                    background-color: #f38321;
                    color: white;
                  ">You have new comment</div>`;
                }
                // Check if there's a mark (task has been graded)
                else if (submission.mark !== null && submission.mark !== undefined) {
                  notificationHTML = `
                  <div class="expired-indicator" style="
                    background-color: #2ecc71;
                    color: white;
                  ">Your mark has been graded</div>`;
                }

                // If we have a notification, add it to the task element
                if (notificationHTML) {
                  // Insert at the beginning of the task element
                  taskElement.insertAdjacentHTML('afterbegin', notificationHTML);
                }
              }
            } catch (error) {
              console.error(`Error checking submission for task ${task.id}:`, error);
            }
          })();
        }
      } catch (error) {
        console.error("Error rendering task:", error, task);
      }
    });

    // Add the wrapper to the task list
    taskListElement.appendChild(tasksWrapper);

    // Add a spacer element at the end to ensure the last task is fully visible
    const spacer = document.createElement("div");
    spacer.style.height = "20px";
    taskListElement.appendChild(spacer);
  }

  // Add CSS for the notification styles if not already present
  function addNotificationStyles() {
    // Check if styles already exist
    if (!document.getElementById('task-notification-styles')) {
      const style = document.createElement('style');
      style.id = 'task-notification-styles';
      style.textContent = `
      .expired-indicator {
          position: absolute;
          top: -10px;
          right: 10px;
          background-color: #dc3545;
          color: white;
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 14px;
          font-weight: bold;
          z-index: 1;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
    `;
      document.head.appendChild(style);
    }
  }

  // Call this function when the page loads
  addNotificationStyles();

  // Function to load the intern's class with mock data
  function loadInternClass() {
    console.log("Loading intern class");

    // Get the intern ID from the hidden input
    const classroom = document.getElementById("class_Id");
    const userIdElement = document.getElementById("user_id");
    if (userIdElement && userIdElement.value) {
      internId = userIdElement.value;
      console.log("User ID from input:", internId);
      classId = classroom.value;
      console.log("User ID from input:", internId);
    } else {
      console.error("No intern ID found in input");
      const errorMessage = document.getElementById("error-message");
      if (errorMessage) {
        errorMessage.style.display = "block";
        errorMessage.textContent = "Không tìm thấy ID thực tập sinh. Vui lòng đăng nhập lại.";
      }
    }
  }

  function loadClassData(classId) {
    console.log("Loading class data for class ID:", classId);

    // Show loading indicator
    const loadingIndicator = document.getElementById("loading-indicator");
    const errorMessage = document.getElementById("error-message");
    const classContent = document.getElementById("class-content");

    if (loadingIndicator) loadingIndicator.style.display = "block";
    if (errorMessage) errorMessage.style.display = "none";
    if (classContent) classContent.style.display = "none";

    fetch(`/api/class/${classId}`)
            .then(response => {
              if (!response.ok) {
                throw new Error('Không thể lấy dữ liệu lớp học từ server');
              }
              return response.json();
            })
            .then(classData => {
              console.log("Class data retrieved:", classData);
              if (classData && classData.conversation && classData.conversation.id) {
                conversationId = classData.conversation.id;
              } else {
                console.warn("No conversation ID found in class data");
                conversationId = "default-conversation";
              }

              // Display class details
              displayClassDetails(classData);

              // Load students
              loadStudents(classId);

              // Load tasks
              fetchTasks(classId);

              // Load chat messages bằng cách gọi loadClassroomConversation với dữ liệu thực tế
              loadClassroomConversation(classData.id, classData.className);

              // Connect to WebSocket for real-time chat
              connectWebSocket();

              // Hide loading indicator and show content
              if (loadingIndicator) loadingIndicator.style.display = "none";
              if (classContent) classContent.style.display = "block";
            })
            .catch(error => {
              console.error("Lỗi khi lấy dữ liệu lớp học:", error);
              // Xử lý lỗi mà không quay lại mock data
              if (loadingIndicator) loadingIndicator.style.display = "none";
              if (errorMessage) {
                errorMessage.style.display = "block";
                errorMessage.textContent = "Không thể tải dữ liệu lớp học. Vui lòng thử lại sau.";
              }
            });
  }

  // Function to display class details
  function displayClassDetails(classData) {
    const className = document.getElementById("className");
    const classTime = document.getElementById("classTime");
    const mentorName = document.getElementById("mentorName");
    const mentorAvatar = document.getElementById("mentorAvatar");
    const mentorInitials = document.getElementById("mentorInitials");
    const chatTitle = document.getElementById("chatTitle");

    if (className) className.textContent = classData.className || "Unnamed Class";

    // Format date and time
    if (classTime) {
      try {
        const createdAt = new Date(classData.createdAt);
        const formattedDate = createdAt.toLocaleDateString("vi-VN", { day: '2-digit', month: '2-digit', year: 'numeric' });
        const formattedTime = createdAt.toLocaleTimeString("vi-VN", { hour: '2-digit', minute: '2-digit' });
        classTime.textContent = `${formattedDate} - ${formattedTime}`;
      } catch (error) {
        console.error("Error formatting date:", error);
        classTime.textContent = "Invalid Date";
      }
    }

    // Set mentor information
    if (mentorName && classData.manager) {
      const mentorFullName = `${classData.manager.first_name || ''} ${classData.manager.last_name || ''}`.trim();
      mentorName.textContent = mentorFullName || "Unknown Mentor";
    }

    // Get mentor ID and fetch avatar
    if (classData.manager && classData.manager.id) {
      const mentorId = classData.manager.id;
      console.log("Mentor ID:", mentorId);

      // Fetch mentor avatar using the mentor ID
      fetchMentorAvatar(mentorId, mentorAvatar, mentorInitials);
    } else {
      // If no mentor ID, show initials
      if (mentorInitials && classData.manager) {
        const firstInitial = classData.manager.first_name ? classData.manager.first_name.charAt(0) : '';
        const lastInitial = classData.manager.last_name ? classData.manager.last_name.charAt(0) : '';
        mentorInitials.textContent = (firstInitial + lastInitial) || "?";
        mentorInitials.style.display = "block";
      }
    }

    // Set chat title
    if (chatTitle) chatTitle.textContent = classData.className || "Class Chat";
  }

  // fetch Mentor avatar
  function fetchMentorAvatar(mentorId, avatarElement, initialsElement) {
    if (!mentorId || !avatarElement || !initialsElement) {
      console.error("Missing required parameters for fetchMentorAvatar");
      return;
    }

    // Make API call to get user details including avatar
    fetch(`/api/user/${mentorId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to fetch mentor details');
              }
              return response.json();
            })
            .then(userData => {
              console.log("Mentor data retrieved:", userData.avatar_path);

              // Check if avatar URL exists
              if (userData && userData.avatar_path) {
                // Create and set image
                const img = document.createElement('img');
                img.src = userData.avatar_path;
                img.alt = "Mentor Avatar";
                img.style.width = "7%";
                img.style.height = "7%";
                img.style.objectFit = "cover";
                img.style.borderRadius = "50%"; // Make the image itself circular
                img.onerror = function() {
                  // If image fails to load, show initials instead
                  this.style.display = 'none';
                  initialsElement.style.display = 'block';
                };

                // Clear avatar container and add image
                avatarElement.innerHTML = '';
                avatarElement.appendChild(img);
                initialsElement.style.display = 'none';
              } else {
                // If no avatar, ensure initials are visible
                initialsElement.style.display = 'block';
              }
            })
            .catch(error => {
              console.error("Error fetching mentor avatar:", error);
              // Show initials as fallback
              initialsElement.style.display = 'block';
            });
  }

  // Function to display students
  function displayStudents(students) {
    const studentContainer = document.getElementById("student-container");
    if (!studentContainer) {
      console.error("Student container element not found");
      return;
    }

    studentContainer.innerHTML = "";

    if (!students || students.length === 0) {
      studentContainer.innerHTML = '<div class="text-muted">Không có sinh viên nào trong lớp</div>';
      return;
    }

    students.forEach(student => {
      try {
        const studentBadge = document.createElement("div");
        studentBadge.className = "student-badge";

        // Format the student name
        const studentName = `${student.first_name || ''} ${student.last_name || ''}`.trim();
        studentBadge.textContent = studentName || "Unnamed Student";

        // Highlight the current intern
        if (student.id === internId) {
          studentBadge.style.backgroundColor = "#e3f2fd";
          studentBadge.style.borderColor = "#007bff";
          studentBadge.style.fontWeight = "bold";
        }

        studentContainer.appendChild(studentBadge);
      } catch (error) {
        console.error("Error rendering student:", error, student);
      }
    });
  }

  async function loadClassroomConversation(classId, className) {
    try {
      // Fetch class details to get conversation_id
      const classResponse = await fetch(`/api/class/${classId}`);
      if (!classResponse.ok) {
        throw new Error("Failed to fetch class details");
      }
      const classData = await classResponse.json();

      // Get chat container
      const chatContainer = document.getElementById("chatContainer");

      // Set up chat container with header and message area
      chatContainer.innerHTML = `
            <div class="chat-box">
                <!-- Chat Header -->
                <div class="chat-header p-3 border-bottom">
                    <h5 class="mb-0">${className}</h5>
                </div>

                <!-- Chat Messages -->
                <div class="chat-container" id="chat">
                    <div class="text-center p-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message" placeholder="Nhập tin nhắn...">
                        <button class="btn btn-warning" onclick="sendMessage()">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

      // Set conversation ID and name
      conversationId = classData.conversation.id;
      conversationName = className;

      // Load existing messages
      await loadMessages(conversationId);

      // Set up message input and send button
      const messageInput = chatContainer.querySelector('#message');
      const sendButton = chatContainer.querySelector('.btn-warning');

      // Add event listeners
      messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });

      sendButton.addEventListener('click', function() {
        sendMessage();
      });

    } catch (error) {
      console.error("Error loading classroom conversation:", error);
      document.getElementById("chatContainer").innerHTML = `
            <div class="alert alert-danger">
                Không thể tải tin nhắn. Vui lòng thử lại sau.
            </div>
        `;
    }
  }

  // Function to open task detail modal
  function openTaskDetailModal(task) {
    const taskName = document.getElementById("task-name");
    const taskDescription = document.getElementById("task-description");
    const taskStartTime = document.getElementById("task-start-time");
    const taskEndTime = document.getElementById("task-end-time");
    const fileContainer = document.getElementById("task-file-container");
    const fileName = document.getElementById("task-file-name");
    const fileLink = document.getElementById("task-file-link");
    const taskDetailModal = document.getElementById("taskDetailModal");
    const submitButton = document.getElementById("submit-task-btn");
    const taskLinkContainer = document.getElementById("task-link-container");
    const taskLink = document.getElementById("task-link");

    // Kiểm tra các phần tử HTML
    if (
            !taskName ||
            !taskDescription ||
            !taskStartTime ||
            !taskEndTime ||
            !fileContainer ||
            !fileName ||
            !fileLink ||
            !taskDetailModal ||
            !submitButton ||
            !taskLinkContainer ||
            !taskLink
    ) {
      console.error("One or more task modal elements not found");
      return;
    }

    // Log task để debug
    console.log("Task object:", task);

    // Set task details
    taskName.textContent = task.taskName || "Unnamed Task";
    taskDescription.textContent = task.description || "Không có mô tả";

    // Handle task link
    if (task.link) {
      taskLinkContainer.style.display = "block";
      taskLink.innerHTML = `<a href="${task.link}" target="_blank">${task.link}</a>`;
    } else {
      taskLinkContainer.style.display = "none";
    }

    // Format dates
    try {
      const startTime = new Date(task.startTime);
      const endTime = new Date(task.endTime);
      const currentTime = new Date();

      // Check if task has expired
      const isExpired = currentTime > endTime;

      const formattedStartTime = startTime.toLocaleString("vi-VN", {
        hour: "2-digit",
        minute: "2-digit",
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });

      const formattedEndTime = endTime.toLocaleString("vi-VN", {
        hour: "2-digit",
        minute: "2-digit",
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });

      taskStartTime.textContent = formattedStartTime;

      // Apply styling to end time based on expiration
      if (isExpired) {
        taskEndTime.innerHTML = `<span class="text-danger fw-bold">${formattedEndTime}</span> <span class="badge bg-danger">Đã hết hạn</span>`;
        submitButton.disabled = true;
        submitButton.title = "Đã hết hạn nộp bài";
      } else {
        taskEndTime.textContent = formattedEndTime;
        submitButton.disabled = false;
        submitButton.title = "";
      }

      // Store expired status in modal
      taskDetailModal.dataset.expired = isExpired;
    } catch (error) {
      console.error("Error formatting task dates:", error);
      taskStartTime.textContent = "Invalid Date";
      taskEndTime.textContent = "Invalid Date";
    }

    // Xử lý fileData
    if (task.fileData) {
      fileContainer.style.display = "block";
      const extractedFileName = task.fileData.split("/").pop() || "file.pdf";
      fileName.textContent = extractedFileName;
      fileLink.href = "#";
      fileLink.onclick = () => {
        window.open(task.fileData, "_blank");
        return false;
      };
    } else {
      fileContainer.style.display = "none";
      console.warn("No fileData provided for task");
    }

    // Load submission history
    loadSubmissionHistory(task.id);

    // Store task ID
    taskDetailModal.setAttribute("data-task-id", task.id);

    // Show modal
    const modal = new bootstrap.Modal(taskDetailModal);
    modal.show();
  }

  // Function to load submission history
  function loadSubmissionHistory(taskId) {
    console.log("Loading submission history for task ID:", taskId);

    const submissionList = document.getElementById("submission-list");
    const submitButton = document.getElementById("submit-task-btn"); // Reference to submit button

    if (!submissionList) {
      console.error("Submission list element not found");
      return;
    }

    if (!submitButton) {
      console.error("Submit button element not found");
      return;
    }

    submissionList.innerHTML = `
      <div class="text-center py-2">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <span>Đang tải lịch sử nộp bài...</span>
      </div>
  `;

    fetch(`/api/completed-tasks/find/${taskId}/${internId}/${classId}`)
            .then(response => {
              if (!response.ok) {
                throw new Error('Không thể lấy lịch sử nộp bài từ server');
              }
              return response.json();
            })
            .then(submissions => {
              console.log("Submissions retrieved:", submissions);

              // Check if submissions.mark is not null
              if (submissions.mark !== null) {
                submitButton.disabled = true;
                submitButton.title = "Bài đã được chấm, không thể nộp lại";
              } else {
                // Ensure button is enabled if mark is null and task is not expired
                const taskDetailModal = document.getElementById("taskDetailModal");
                const isExpired = taskDetailModal.dataset.expired === "true";
                submitButton.disabled = isExpired; // Respect expiration status
                submitButton.title = isExpired ? "Đã hết hạn nộp bài" : "";
              }

              // Display submission history
              displaySubmissionHistory(submissions);
            })
            .catch(error => {
              console.error("Lỗi khi lấy lịch sử nộp bài:", error);
              // Show empty state
              submissionList.innerHTML = `
          <div class="alert alert-info">
              Bạn chưa có bài nộp nào cho task này.
          </div>
      `;
            });
  }

  // Function to display submission history
  function displaySubmissionHistory(submissions) {
    const submissionList = document.getElementById("submission-list")
    const submitButton = document.getElementById("submit-task-btn")
    const taskDetailModal = document.getElementById("taskDetailModal")

    if (!submissionList || !submitButton || !taskDetailModal) {
      console.error("Submission list or submit button element not found")
      return
    }

    submissionList.innerHTML = ""

    if (!submissions) {
      submissionList.innerHTML = `
            <div class="alert alert-info">
                Bạn chưa có bài nộp nào cho task này.
            </div>
        `
      return
    }

    const submissionArray = Array.isArray(submissions) ? submissions : [submissions]

    if (submissionArray.length === 0) {
      submissionList.innerHTML = `
            <div class="alert alert-info">
                Bạn chưa có bài nộp nào cho task này.
            </div>
        `
      return
    }

    // Check if task is expired
    const isExpired = taskDetailModal.dataset.expired === "true"

    let hasCompletedSubmission = false

    submissionArray.forEach((submission) => {
      try {
        const submissionDate = new Date(submission.createdAt)
        const formattedDate = submissionDate.toLocaleString("vi-VN")

        // Check if this submission is completed
        const isCompleted = submission.status === "PENDING"
        if (isCompleted) {
          hasCompletedSubmission = true
        }

        const submissionItem = document.createElement("div")
        submissionItem.className = "card mb-2"

        // Create mentor comment section if status is COMPLETED
        let mentorCommentHTML = ""
        if (isCompleted && submission.comment) {
          mentorCommentHTML = `
            <div class="mentor-comment mt-2 p-2 border-start border-4 border-info bg-light rounded">
              <div class="mentor-comment-header fw-bold mb-1">
                 Nhận xét của mentor:
              </div>
              <div class="ps-2">${submission.comment || "Không có nhận xét"}</div>
            </div>
          `
        }

        // Create mark/score section if it exists
        let markHTML = ""
        if (submission.mark !== null && submission.mark !== undefined) {
          markHTML = `
            <div class="submission-mark mt-2 mb-2">
              <div class="d-flex align-items-center">

                <span class="fw-bold">Score:</span>
                <span class="ms-2 badge bg-primary fs-6">${submission.mark}</span>
              </div>
            </div>
          `
        }

        submissionItem.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Nộp lúc: ${formattedDate}</strong>
                        <span class="badge bg-${submission.status === "PENDING" ? "warning" : "success"}">${submission.status}</span>
                    </div>
                    <div class="mb-2">
                        <span class="fw-bold">Attachment File:</span>
                        <a href="${submission.file || "#"}" target="_blank" class="text-decoration-none">
                          ${submission.file ? submission.file.split("/").pop() : "Tệp đính kèm"}
                        </a>
                    </div>
                    ${markHTML}
                    ${mentorCommentHTML}
                </div>
            `

        submissionList.appendChild(submissionItem)
      } catch (error) {
        console.error("Error rendering submission:", error, submission)
      }
    })
  }

  // Function to submit a task
  function submitTask() {
    const fileInput = document.getElementById("submission-file");
    const submitButton = document.getElementById("submit-task-btn");
    const taskDetailModal = document.getElementById("taskDetailModal");

    if (!fileInput || !submitButton || !taskDetailModal) {
      console.error("One or more submission form elements not found");
      return;
    }

    const taskId = taskDetailModal.getAttribute("data-task-id");

    // Check if task is expired
    const isExpired = taskDetailModal.dataset.expired === "true";
    if (isExpired) {
      showGlobalAlert("Không thể nộp bài vì đã quá hạn!", "danger");
      return;
    }

    if (isExpired) {
      showGlobalAlert("Không thể nộp bài vì đã quá hạn!", "danger");
      return;
    }

    // Validate form
    if (fileInput.files.length === 0) {
      showGlobalAlert("Vui lòng chọn tệp để nộp!", "warning");
      return;
    }

    // Disable button and show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang nộp...`;
    // Step 1: Upload file to Cloudinary
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    fetch('/cloudinary/upload/uploadFile', {
      method: 'POST',
      body: formData
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Không thể upload file lên Cloudinary');
              }
              return response.json();
            })
            .then(data => {
              console.log("File uploaded to Cloudinary:", data);
              const fileUrl = data.secure_url; // Cloudinary trả về URL trong thuộc tính secure_url

              // Step 2: Delete old CompletedTask (if exists)
              return fetch(`/api/completed-tasks/${taskId}/${internId}/${classId}`, {
                method: 'DELETE'
              })
                      .then(deleteResponse => {
                        if (!deleteResponse.ok && deleteResponse.status !== 404) {
                          throw new Error('Không thể xóa CompletedTask cũ');
                        }
                        console.log("Old CompletedTask deleted or not found");

                        // Step 3: Create new CompletedTask
                        const newTask = {
                          id: {
                            taskId: parseInt(taskId),
                            userId: parseInt(internId),
                            classId: parseInt(classId)
                          },
                          file: fileUrl, // Sử dụng URL từ Cloudinary
                          status: "PENDING",
                          createdAt: new Date().toISOString(),
                          isActive: true
                        };

                        return fetch('/api/completed-tasks/create', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify(newTask)
                        });
                      });
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Không thể tạo CompletedTask mới');
              }
              return response.json();
            })
            .then(result => {
              console.log("New CompletedTask created:", result);

              // Reset form
              document.getElementById("submission-form").reset();

              // Reload submission history
              loadSubmissionHistory(taskId);

              // Show success message
              showGlobalAlert("Nộp bài thành công!", "success");
            })
            .catch(error => {
              console.error("Lỗi khi nộp bài:", error);
              showGlobalAlert("Không thể nộp bài. Vui lòng thử lại sau.", "danger");
            })
            .finally(() => {
              // Reset button
              submitButton.disabled = false;
              submitButton.textContent = "Nộp bài";
            });
  }

  async function loadSubmissionHistory2(taskId) {
    console.log("Loading submission history for task ID:", taskId);

    const submissionList = document.getElementById("submission-list");
    if (!submissionList) {
      console.error("Submission list element not found");
      throw new Error("Submission list element not found");
    }

    submissionList.innerHTML = `
        <div class="text-center py-2">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span>Đang tải lịch sử nộp bài...</span>
        </div>
    `;

    try {
      const response = await fetch(`/api/completed-tasks/find/${taskId}/${internId}/${classId}`);
      if (!response.ok) {
        throw new Error('Không thể lấy lịch sử nộp bài từ server');
      }
      const submissions = await response.json();
      console.log("Submissions retrieved:", submissions);
      displaySubmissionHistory(submissions);
      return submissions; // Trả về danh sách submissions
    } catch (error) {
      console.error("Lỗi khi lấy lịch sử nộp bài:", error);
      // Show empty state
      submissionList.innerHTML = `
            <div class="alert alert-info">
                Bạn chưa có bài nộp nào cho task này.
            </div>
        `;
      throw error; // Ném lỗi để hàm gọi có thể xử lý
    }
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="/assets/js/messenger.js"></script>
</body>
</html>
